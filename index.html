<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RASSTUBE ULTIMATE | v4.0 Elite Ecosystem</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #FF0032;
            --accent-soft: rgba(255, 0, 50, 0.15);
            --accent-glow: rgba(255, 0, 50, 0.5);
            --bg-deep: #050505;
            --bg-card: #0F0F0F;
            --bg-elevated: #1A1A1A;
            --bg-input: #121212;
            --text-main: #FFFFFF;
            --text-dim: #909090;
            --border: rgba(255, 255, 255, 0.08);
            --ai-color: #00D1FF;
            --success: #00FF85;
            --warning: #FFAA00;
            --radius-xl: 32px;
            --radius-lg: 20px;
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.6);
            --transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-deep); color: var(--text-main); 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden; -webkit-user-select: none;
            min-height: 100vh;
        }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseAccent { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 50, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 50, 0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- AUTHENTIFICATION ENGINE --- */
        #auth-portal {
            position: fixed; 
            inset: 0; 
            z-index: 9999; 
            background: radial-gradient(circle at top right, #1a0505, #000);
            display: flex; 
            align-items: flex-start; /* Permet le d√©filement */
            justify-content: center; 
            padding: 20px;
            overflow-y: auto; /* Permet le d√©filement vertical */
            -webkit-overflow-scrolling: touch; /* D√©filement fluide sur mobile */
        }

        .auth-container {
            width: 100%; 
            max-width: 440px; 
            background: var(--bg-card);
            border-radius: var(--radius-xl); 
            border: 1px solid var(--border);
            padding: 40px 35px; 
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.8s ease;
            margin: 20px 0; /* Marge pour le d√©filement */
        }

        .auth-tabs {
            display: flex; background: var(--bg-input); padding: 6px;
            border-radius: 18px; margin-bottom: 30px; border: 1px solid var(--border);
        }

        .auth-tabs button {
            flex: 1; padding: 14px; border: none; background: none;
            color: var(--text-dim); font-weight: 700; cursor: pointer;
            border-radius: 14px; transition: var(--transition);
        }

        .auth-tabs button.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); }

        .input-box { margin-bottom: 20px; position: relative; }
        .input-box i { position: absolute; left: 18px; top: 18px; color: var(--text-dim); font-size: 18px; }
        .input-control {
            width: 100%; padding: 18px 18px 18px 52px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 18px; color: white;
            font-size: 15px; transition: var(--transition);
        }
        .input-control:focus { border-color: var(--accent); outline: none; background: #161616; }

        .pfp-selector { text-align: center; margin-bottom: 25px; }
        .pfp-main-preview {
            width: 110px; height: 110px; border-radius: 50%;
            border: 3px solid var(--accent); padding: 4px; object-fit: cover;
            margin-bottom: 15px; transition: var(--transition);
        }
        .pfp-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px;
        }
        .pfp-item {
            aspect-ratio: 1; border-radius: 14px; overflow: hidden; cursor: pointer;
            border: 2px solid transparent; transition: var(--transition);
        }
        .pfp-item.selected { border-color: var(--accent); transform: scale(1.1); }
        .pfp-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- CORE APP LAYOUT --- */
        #main-app { display: none; padding-bottom: 100px; min-height: 100vh; }

        .top-nav {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(25px);
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }

        .nav-wrapper {
            max-width: 1200px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
        }

        .brand { font-size: 28px; font-weight: 900; color: var(--accent); letter-spacing: -1.5px; }

        .search-bar {
            background: var(--bg-elevated); border-radius: 14px;
            padding: 10px 18px; display: flex; align-items: center;
            width: 40%; border: 1px solid var(--border);
        }
        .search-bar input { background: none; border: none; color: white; margin-left: 10px; width: 100%; outline: none; }

        /* --- SECTIONS --- */
        .content-container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* Stories */
        .story-scroller {
            display: flex; gap: 18px; overflow-x: auto; padding: 10px 0 25px;
            scrollbar-width: none;
        }
        .story-scroller::-webkit-scrollbar { display: none; }
        .story-card {
            flex-shrink: 0; width: 85px; text-align: center; cursor: pointer;
        }
        .story-ring {
            width: 78px; height: 78px; border-radius: 50%; padding: 3px;
            background: linear-gradient(45deg, #FF0032, #FF8A00);
            margin-bottom: 8px; transition: var(--transition);
        }
        .story-card img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--bg-deep); object-fit: cover; }
        .story-card:active .story-ring { transform: scale(0.9); }
        .story-label { font-size: 11px; font-weight: 600; color: var(--text-dim); }

        /* Post Card */
        .post {
            background: var(--bg-card); border-radius: var(--radius-lg);
            margin-bottom: 35px; border: 1px solid var(--border);
            overflow: hidden; animation: fadeIn 0.6s ease;
        }
        .post-head { padding: 18px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 14px; }
        .user-info img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .user-meta h4 { margin: 0; font-size: 15px; font-weight: 700; }
        .user-meta span { font-size: 11px; color: var(--text-dim); }

        .post-media { width: 100%; background: #000; position: relative; cursor: pointer; }
        .post-media img, .post-media video { width: 100%; display: block; max-height: 650px; object-fit: contain; }

        .post-actions { padding: 15px 20px; display: flex; gap: 25px; font-size: 24px; }
        .action-btn { cursor: pointer; transition: var(--transition); color: var(--text-main); }
        .action-btn:active { transform: scale(1.3); }
        .action-btn.active { color: var(--accent); }

        .post-details { padding: 0 20px 20px; }
        .likes-count { font-weight: 800; font-size: 14px; margin-bottom: 8px; display: block; }
        .caption { font-size: 14px; line-height: 1.5; }
        .caption b { margin-right: 8px; color: var(--accent); }

        /* --- BOTTOM NAV --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(30px);
            border-top: 1px solid var(--border); padding: 12px 10px 32px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
        }
        .nav-item { 
            color: var(--text-dim); text-align: center; 
            flex: 1; transition: var(--transition); cursor: pointer; 
            position: relative;
        }
        .nav-item.active { color: var(--accent); transform: translateY(-5px); }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

        .fab-upload {
            background: var(--accent); width: 60px; height: 60px;
            border-radius: 22px; display: flex; align-items: center; justify-content: center;
            margin-top: -45px; border: 6px solid var(--bg-deep);
            color: white !important; font-size: 26px !important;
            animation: pulseAccent 2s infinite;
            cursor: pointer;
        }
        .fab-upload.active { background: var(--success); }

        /* --- MODALS & OVERLAYS --- */
        .modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.95); display: none;
            padding: 20px; overflow-y: auto;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: var(--bg-card); border-radius: var(--radius-lg);
            max-width: 800px; width: 100%; overflow: hidden;
        }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; border-bottom: 1px solid var(--border);
        }
        .modal-header h3 { margin: 0; }

        /* --- TOAST SYSTEM --- */
        #notification-box {
            position: fixed; top: 25px; right: 25px; z-index: 10000;
            max-width: 350px;
        }
        .toast {
            background: var(--bg-elevated); border-left: 4px solid var(--accent);
            padding: 18px 25px; border-radius: 14px; margin-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center;
            gap: 15px; animation: slideInRight 0.5s ease;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: #ff4444; }
        .toast.warning { border-left-color: var(--warning); }

        /* --- LOADER --- */
        .loader {
            width: 30px; height: 30px; border: 3px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        .loader.active { display: inline-block; }

        /* --- CHAT STYLES --- */
        .chat-message {
            margin-bottom: 15px; padding: 15px; border-radius: 15px;
            max-width: 85%; word-wrap: break-word;
        }
        .user-message {
            background: var(--accent-soft); border: 1px solid var(--accent);
            margin-left: auto; align-self: flex-end;
        }
        .ai-message {
            background: var(--bg-elevated); border-left: 4px solid var(--ai-color);
            margin-right: auto; align-self: flex-start;
        }

        /* --- SUBSCRIBE BUTTON --- */
        .subscribe-btn {
            background: var(--accent); color: white; border: none;
            padding: 8px 16px; border-radius: 12px; font-weight: 700;
            cursor: pointer; transition: var(--transition); font-size: 13px;
        }
        .subscribe-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--accent-glow); }
        .subscribe-btn.subscribed { background: var(--bg-elevated); color: var(--text-dim); border: 1px solid var(--border); }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .nav-wrapper { flex-wrap: wrap; gap: 15px; }
            .search-bar { width: 100%; order: 3; }
            .content-container { padding: 15px; }
            .auth-container { 
                padding: 30px 25px; 
                margin: 10px 0;
            }
            #auth-portal { padding: 15px; align-items: flex-start; }
            .pfp-grid { grid-template-columns: repeat(3, 1fr); }
            .bottom-bar { padding: 12px 5px 32px; }
            .nav-item i { font-size: 22px; }
            .nav-item span { font-size: 9px; }
            .modal-content { margin: 10px; }
        }

        @media (max-width: 480px) {
            .brand { font-size: 24px; }
            .post-actions { font-size: 22px; gap: 20px; }
            .story-card { width: 70px; }
            .story-ring { width: 65px; height: 65px; }
            .auth-container { padding: 25px 20px; border-radius: 25px; }
            .auth-tabs { margin-bottom: 25px; }
            .input-box { margin-bottom: 18px; }
        }
    </style>
</head>
<body>

<div id="notification-box"></div>

<div id="auth-portal">
    <div class="auth-container">
        <div class="brand text-center" style="margin-bottom: 30px; font-size: 42px;">RASSTUBE</div>
        
        <div class="auth-tabs">
            <button id="tab-login" class="active" onclick="App.toggleAuth('login')">CONNEXION</button>
            <button id="tab-signup" onclick="App.toggleAuth('signup')">INSCRIPTION</button>
        </div>

        <div id="signup-profile-setup" class="hidden">
            <div class="pfp-selector">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Rass" class="pfp-main-preview" id="auth-pfp-preview">
                <div class="mt-20">
                    <button onclick="App.triggerPfpUpload()" style="background:var(--accent-soft); color:var(--accent); border:none; padding:10px 20px; border-radius:12px; font-weight:700; cursor:pointer; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="fas fa-camera"></i> MA PHOTO
                    </button>
                </div>
                <input type="file" id="real-pfp-input" class="hidden" accept="image/*" onchange="App.handlePfpFile(event)">
                
                <div class="pfp-grid" id="default-avatars"></div>
            </div>
            
            <div class="input-box">
                <i class="fas fa-user-tag"></i>
                <input type="text" id="reg-pseudo" class="input-control" placeholder="Ton Pseudo Elite">
            </div>
        </div>

        <div class="input-box">
            <i class="fas fa-envelope"></i>
            <input type="email" id="auth-email" class="input-control" placeholder="Adresse e-mail">
        </div>
        
        <div class="input-box">
            <i class="fas fa-lock"></i>
            <input type="password" id="auth-pass" class="input-control" placeholder="Mot de passe (6+ caract√®res)">
        </div>

        <button onclick="App.executeAuth()" id="auth-btn" style="width: 100%; padding: 22px; background: var(--accent); color: white; border: none; border-radius: 20px; font-weight: 800; font-size: 16px; margin-top: 15px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span id="auth-btn-text">REJOINDRE LE R√âSEAU</span>
            <div class="loader" id="auth-loader"></div>
        </button>
        
        <p id="auth-msg" style="text-align: center; color: #ff4444; font-size: 13px; margin-top: 20px; display: none;"></p>
    </div>
</div>

<div id="main-app">
    <header class="top-nav">
        <div class="nav-wrapper">
            <div class="brand">RASSTUBE</div>
            <div class="search-bar">
                <i class="fas fa-search" style="color:var(--text-dim)"></i>
                <input type="text" id="search-input" placeholder="Rechercher sur le r√©seau..." onkeyup="App.filterContent(this.value)">
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <i class="fas fa-paper-plane" style="font-size: 20px; cursor: pointer;" title="Messages" onclick="App.showMessages()"></i>
                <img src="" id="user-pfp-top" style="width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent); cursor: pointer;" onclick="App.go('profile')" alt="Profil">
            </div>
        </div>
    </header>

    <main class="content-container">
        <section id="sec-home" class="app-section">
            <div class="story-scroller" id="story-container"></div>
            <div id="main-feed"></div>
        </section>

        <section id="sec-discover" class="app-section hidden">
            <h2 style="margin-bottom: 25px;">Tendances <i class="fas fa-fire" style="color:var(--accent)"></i></h2>
            <div id="discover-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;"></div>
        </section>

        <section id="sec-upload" class="app-section hidden">
            <div class="auth-container" style="max-width: 100%; box-shadow: none; padding: 35px;">
                <h3 style="margin-top: 0; margin-bottom: 25px;"><i class="fas fa-plus-circle"></i> Nouvelle Publication</h3>
                
                <div class="input-box" style="border: 2px dashed var(--border); border-radius: 20px; padding: 40px; text-align: center; cursor: pointer;" onclick="document.getElementById('file-upload').click()" id="upload-dropzone">
                    <i class="fas fa-cloud-upload-alt" style="position: static; font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
                    <p style="margin: 0; font-weight: 700;">Clique pour importer (Vid√©o ou Photo)</p>
                    <p style="margin: 10px 0 0; font-size: 13px; color: var(--text-dim);">Max. 50MB - MP4, MOV, JPG, PNG</p>
                    <input type="file" id="file-upload" class="hidden" accept="video/*,image/*" onchange="App.previewUpload(event)">
                </div>

                <div id="upload-preview" class="hidden" style="margin: 25px 0; border-radius: 15px; overflow: hidden; position: relative;">
                    <button onclick="document.getElementById('upload-preview').classList.add('hidden'); document.getElementById('file-upload').value = '';" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
                </div>

                <div class="input-box">
                    <i class="fas fa-heading"></i>
                    <input type="text" id="up-title" class="input-control" placeholder="Titre de la publication">
                </div>

                <button onclick="App.publishPost()" style="width: 100%; padding: 20px; background: var(--accent); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span id="publish-text">PUBLIER</span>
                    <div class="loader" id="publish-loader"></div>
                </button>
            </div>
        </section>

        <section id="sec-profile" class="app-section hidden">
            <div style="text-align: center; margin-bottom: 40px;">
                <img src="" id="prof-pfp" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); padding: 5px; margin-bottom: 20px; object-fit: cover;">
                <h2 id="prof-name" style="margin: 0; font-size: 28px;">Pseudo</h2>
                <p id="prof-email" style="color: var(--text-dim); margin-top: 5px;"></p>
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 25px;">
                    <div><b style="display: block; font-size: 18px;" id="count-posts">0</b><span style="font-size: 11px; color: var(--text-dim);">POSTS</span></div>
                    <div><b style="display: block; font-size: 18px;" id="count-followers">0</b><span style="font-size: 11px; color: var(--text-dim);">ABONN√âS</span></div>
                    <div><b style="display: block; font-size: 18px;" id="count-following">0</b><span style="font-size: 11px; color: var(--text-dim);">ABONNEMENTS</span></div>
                </div>
                <button onclick="App.logout()" style="margin-top: 30px; padding: 12px 25px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; color: #ff4444; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-sign-out-alt"></i> DECONNEXION
                </button>
            </div>
            <div id="profile-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
        </section>
    </main>

    <nav class="bottom-bar">
        <div class="nav-item active" onclick="App.go('home')">
            <i class="fas fa-home"></i>
            <span>Flux</span>
        </div>
        <div class="nav-item" onclick="App.go('discover')">
            <i class="fas fa-compass"></i>
            <span>Tendances</span>
        </div>
        <div class="fab-upload" onclick="App.go('upload')" id="fab-upload-btn">
            <i class="fas fa-plus"></i>
        </div>
        <div class="nav-item" onclick="App.openAIChat()">
            <i class="fas fa-robot"></i>
            <span>IA</span>
        </div>
        <div class="nav-item" onclick="App.go('profile')">
            <i class="fas fa-user"></i>
            <span>Profil</span>
        </div>
    </nav>
</div>

<script>
/**
 * RASSTUBE CORE ENGINE v4.0 - SIMPLIFI√â ET FONCTIONNEL
 */

const App = {
    // √âTAT GLOBAL
    state: {
        users: JSON.parse(localStorage.getItem('rt_v4_users') || '[]'),
        posts: JSON.parse(localStorage.getItem('rt_v4_posts') || '[]'),
        session: JSON.parse(localStorage.getItem('rt_v4_session') || 'null'),
        currentTab: 'login',
        selectedPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Rass',
        activeSection: 'home',
        isUploading: false,
        subscriptions: JSON.parse(localStorage.getItem('rt_v4_subscriptions') || '{}'),
        messages: JSON.parse(localStorage.getItem('rt_v4_messages') || '[]'),
        aiResponses: [
            "Bonjour ! Je suis l'IA Rasstube. Comment puis-je vous aider aujourd'hui ?",
            "Je vois que vous √™tes int√©ress√© par le contenu vid√©o. Avez-vous essay√© notre fonctionnalit√© de tendances ?",
            "Pour optimiser votre pr√©sence sur Rasstube, je recommande de publier r√©guli√®rement et d'interagir avec votre communaut√©.",
            "La qualit√© du contenu est essentielle ! Assurez-vous d'utiliser de bonnes lumi√®res et un son clair.",
            "Je remarque que vous posez une question technique. Notre √©quipe travaille constamment √† am√©liorer la plateforme.",
            "Les hashtags pertinents peuvent augmenter votre visibilit√© de plus de 40%.",
            "Publiez aux heures de pointe (18h-21h) pour maximiser votre audience.",
            "L'engagement est la cl√© ! R√©pondez aux commentaires pour construire une communaut√© fid√®le.",
            "N'oubliez pas d'utiliser la fonctionnalit√© 'Stories' pour du contenu √©ph√©m√®re plus personnel.",
            "Votre profil est optimis√© √† 85%. Compl√©tez votre bio pour atteindre 100% !"
        ]
    },

    // INITIALISATION
    init() {
        this.verifySession();
        this.renderAvatars();
        this.sync();

        if(this.state.session) {
            this.launch();
        }
        
        // Ajouter des donn√©es par d√©faut si vide
        if(this.state.posts.length === 0) {
            this.createDefaultPosts();
        }
        
        // Pr√©venir la fermeture accidentelle
        window.addEventListener('beforeunload', (e) => {
            if(this.state.isUploading) {
                e.preventDefault();
                e.returnValue = 'Votre publication est en cours de t√©l√©chargement. Voulez-vous vraiment quitter ?';
            }
        });
    },

    // V√âRIFICATION DE SESSION
    verifySession() {
        if(this.state.session) {
            const userExists = this.state.users.find(u => u.email === this.state.session.email);
            if(!userExists) {
                this.state.session = null;
                this.sync();
            }
        }
    },

    // SYNCHRONISATION
    sync() {
        try {
            localStorage.setItem('rt_v4_users', JSON.stringify(this.state.users));
            localStorage.setItem('rt_v4_posts', JSON.stringify(this.state.posts));
            localStorage.setItem('rt_v4_session', JSON.stringify(this.state.session));
            localStorage.setItem('rt_v4_subscriptions', JSON.stringify(this.state.subscriptions));
            localStorage.setItem('rt_v4_messages', JSON.stringify(this.state.messages));
        } catch(e) {
            console.error('Erreur de sauvegarde:', e);
            this.notify('Erreur de sauvegarde des donn√©es', 'error');
        }
    },

    // CR√âATION DE POSTS PAR D√âFAUT
    createDefaultPosts() {
        const defaultUsers = [
            { pseudo: 'Rayan', pfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Rayan' },
            { pseudo: 'Sarah', pfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah' },
            { pseudo: 'Alex', pfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Alex' },
            { pseudo: 'Lena', pfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Lena' }
        ];
        
        // Ajouter les utilisateurs par d√©faut
        defaultUsers.forEach(user => {
            if(!this.state.users.find(u => u.pseudo === user.pseudo)) {
                this.state.users.push({
                    id: Date.now() + Math.random(),
                    pseudo: user.pseudo,
                    email: `${user.pseudo.toLowerCase()}@example.com`,
                    pass: '123456',
                    pfp: user.pfp,
                    joined: new Date().toLocaleDateString('fr-FR'),
                    followers: Math.floor(Math.random() * 1000) + 100,
                    following: Math.floor(Math.random() * 500) + 50
                });
            }
        });

        const defaultPosts = [
            {
                id: 1,
                author: 'Rayan',
                authorPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Rayan',
                title: 'Mon nouveau setup gaming ! üéÆ',
                type: 'photo',
                content: 'https://images.unsplash.com/photo-1593305841991-05c297ba4575?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                likes: 245,
                likedBy: ['Rayan', 'Sarah'],
                comments: [
                    { user: 'Sarah', text: 'Incroyable !', time: '2h' },
                    { user: 'Alex', text: 'Quelle carte graphique ?', time: '3h' }
                ],
                timestamp: new Date(Date.now() - 3600000).toISOString(),
                views: 2540
            },
            {
                id: 2,
                author: 'Sarah',
                authorPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah',
                title: 'Vlog de ma journ√©e √† Paris üá´üá∑',
                type: 'video',
                content: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4',
                likes: 189,
                likedBy: ['Sarah', 'Alex'],
                comments: [
                    { user: 'Rayan', text: 'Super vlog !', time: '1h' }
                ],
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                views: 1890
            },
            {
                id: 3,
                author: 'Alex',
                authorPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Alex',
                title: 'Recette de cuisine italienne üçù',
                type: 'photo',
                content: 'https://images.unsplash.com/photo-1563379926898-05f4575a45d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                likes: 312,
                likedBy: ['Alex', 'Lena'],
                comments: [
                    { user: 'Lena', text: 'J\'adore la cuisine italienne !', time: '4h' },
                    { user: 'Sarah', text: 'Recette partag√©e !', time: '5h' }
                ],
                timestamp: new Date(Date.now() - 10800000).toISOString(),
                views: 3120
            }
        ];
        
        this.state.posts = defaultPosts;
        this.sync();
    },

    // --- AUTHENTIFICATION ---
    toggleAuth(tab) {
        this.state.currentTab = tab;
        document.getElementById('tab-login').classList.toggle('active', tab === 'login');
        document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
        document.getElementById('signup-profile-setup').classList.toggle('hidden', tab === 'login');
        document.getElementById('auth-btn-text').innerText = tab === 'login' ? "SE CONNECTER" : "CR√âER MON COMPTE";
        
        // R√©initialiser les messages d'erreur
        document.getElementById('auth-msg').style.display = 'none';
    },

    // VALIDATION EMAIL
    validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    },

    // EX√âCUTION AUTHENTIFICATION
    executeAuth() {
        const email = document.getElementById('auth-email').value.trim();
        const pass = document.getElementById('auth-pass').value;
        const pseudo = document.getElementById('reg-pseudo')?.value.trim() || '';
        const msg = document.getElementById('auth-msg');
        const loader = document.getElementById('auth-loader');
        
        // Validation basique
        if(!email || !pass) {
            this.notify("Veuillez remplir tous les champs", "error");
            return;
        }
        
        if(!this.validateEmail(email)) {
            msg.innerText = "Email invalide !";
            msg.style.display = 'block';
            return;
        }
        
        if(pass.length < 6) {
            msg.innerText = "Mot de passe trop court (6+ caract√®res)";
            msg.style.display = 'block';
            return;
        }
        
        // Afficher le loader
        loader.classList.add('active');
        
        // Simuler un d√©lai r√©seau
        setTimeout(() => {
            if(this.state.currentTab === 'signup') {
                if(!pseudo) { 
                    this.notify("Pseudo requis", "error"); 
                    loader.classList.remove('active');
                    return; 
                }
                
                if(pseudo.length < 3) {
                    msg.innerText = "Pseudo trop court (3+ caract√®res)";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }
                
                if(this.state.users.find(u => u.email === email)) {
                    msg.innerText = "Cet email est d√©j√† utilis√© !";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }
                
                if(this.state.users.find(u => u.pseudo === pseudo)) {
                    msg.innerText = "Ce pseudo est d√©j√† pris !";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }

                const newUser = {
                    id: Date.now(),
                    pseudo,
                    email,
                    pass,
                    pfp: this.state.selectedPfp,
                    joined: new Date().toLocaleDateString('fr-FR'),
                    followers: 0,
                    following: 0
                };

                this.state.users.push(newUser);
                this.state.session = newUser;
                this.notify(`Compte cr√©√© avec succ√®s, ${pseudo} !`);
            } else {
                const user = this.state.users.find(u => u.email === email && u.pass === pass);
                if(!user) {
                    msg.innerText = "Email ou mot de passe incorrect";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }
                this.state.session = user;
                this.notify(`Heureux de vous revoir, ${user.pseudo} !`);
            }

            this.sync();
            loader.classList.remove('active');
            this.launch();
        }, 800);
    },

    // LANCEMENT APP
    launch() {
        document.getElementById('auth-portal').classList.add('hidden');
        document.getElementById('main-app').style.display = 'block';
        
        // Mettre √† jour l'interface
        document.getElementById('user-pfp-top').src = this.state.session.pfp;
        document.getElementById('prof-pfp').src = this.state.session.pfp;
        document.getElementById('prof-name').innerText = this.state.session.pseudo;
        document.getElementById('prof-email').innerText = this.state.session.email;
        
        // Calculer les stats
        const userSubscriptions = this.state.subscriptions[this.state.session.pseudo] || { followers: [], following: [] };
        document.getElementById('count-followers').innerText = userSubscriptions.followers.length;
        document.getElementById('count-following').innerText = userSubscriptions.following.length;

        this.renderFeed();
        this.renderStories();
        this.go('home');
    },

    // --- GESTION DES SECTIONS ---
    go(sec) {
        // Masquer toutes les sections
        document.querySelectorAll('.app-section').forEach(s => s.classList.add('hidden'));
        document.getElementById('sec-' + sec).classList.remove('hidden');
        
        // Mettre √† jour la navigation
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        
        // Mapping correct des sections
        const navIndexes = { home: 0, discover: 1, upload: 2, profile: 4 };
        if(navIndexes[sec] !== undefined) {
            document.querySelectorAll('.nav-item')[navIndexes[sec]].classList.add('active');
        }
        
        // G√©rer le bouton FAB sp√©cial
        document.getElementById('fab-upload-btn').classList.toggle('active', sec === 'upload');
        
        // Actions sp√©cifiques
        switch(sec) {
            case 'profile': 
                this.renderProfile(); 
                break;
            case 'discover': 
                this.renderDiscover(); 
                break;
            case 'upload':
                this.resetUploadForm();
                break;
        }
        
        this.state.activeSection = sec;
    },

    // --- FILTRE RECHERCHE ---
    filterContent(query) {
        const feed = document.getElementById('main-feed');
        if(!query.trim()) {
            this.renderFeed();
            return;
        }
        
        const filtered = this.state.posts.filter(p => 
            p.title.toLowerCase().includes(query.toLowerCase()) || 
            p.author.toLowerCase().includes(query.toLowerCase())
        );
        
        if(filtered.length === 0) {
            feed.innerHTML = `
                <div style="text-align:center; padding:50px; color:var(--text-dim);">
                    <i class="fas fa-search" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Aucun r√©sultat pour "${query}"</p>
                    <p style="font-size:13px;">Essayez d'autres mots-cl√©s</p>
                </div>`;
            return;
        }
        
        feed.innerHTML = filtered.map(p => this.renderPost(p)).join('');
    },

    // --- GESTION DES STORIES ---
    renderStories() {
        const cont = document.getElementById('story-container');
        const users = this.state.users
            .filter(u => u.pseudo !== this.state.session.pseudo)
            .slice(0, 8);
        
        cont.innerHTML = `
            <div class="story-card" onclick="App.addStory()">
                <div class="story-ring" style="background:var(--border); border:2px dashed var(--accent)">
                    <img src="${this.state.session.pfp}">
                    <div style="position:absolute; bottom:-5px; right:-5px; background:var(--accent); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:3px solid var(--bg-deep);">
                        <i class="fas fa-plus" style="font-size:10px;"></i>
                    </div>
                </div>
                <span class="story-label">Votre story</span>
            </div>
        ` + users.map(u => `
            <div class="story-card" onclick="App.viewStory('${u.pseudo}')">
                <div class="story-ring"><img src="${u.pfp}"></div>
                <span class="story-label">${u.pseudo}</span>
            </div>
        `).join('');
    },

    addStory() {
        this.notify('Ajoutez une photo ou vid√©o √©ph√©m√®re !', 'info');
        setTimeout(() => {
            this.notify('Story publi√©e pour 24h !', 'success');
        }, 1000);
    },

    viewStory(user) {
        this.notify(`Story de ${user} en cours de chargement...`, 'info');
        setTimeout(() => {
            this.notify(`Vous avez vu la story de ${user}`, 'success');
        }, 1500);
    },

    // --- CR√âATION DE CONTENU ---
    previewUpload(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('upload-preview');
        
        if(!file) return;
        
        // V√©rifier la taille (50MB max)
        if(file.size > 50 * 1024 * 1024) {
            this.notify('Fichier trop volumineux (max 50MB)', 'error');
            e.target.value = '';
            return;
        }
        
        preview.innerHTML = '';
        preview.classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (event) => {
            if(file.type.includes('video')) {
                preview.innerHTML = `
                    <video src="${event.target.result}" style="width:100%; border-radius:10px;" controls autoplay muted></video>
                `;
            } else {
                preview.innerHTML = `
                    <img src="${event.target.result}" style="width:100%; border-radius:10px; max-height:400px; object-fit:cover;">
                `;
            }
        };
        reader.readAsDataURL(file);
    },

    resetUploadForm() {
        document.getElementById('up-title').value = '';
        document.getElementById('upload-preview').innerHTML = '';
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('file-upload').value = '';
    },

    publishPost() {
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        const title = document.getElementById('up-title').value.trim();
        const publishBtn = document.getElementById('publish-text');
        const loader = document.getElementById('publish-loader');
        
        if(!file || !title) {
            this.notify("Fichier et titre obligatoires !", "error");
            return;
        }
        
        if(title.length < 3) {
            this.notify("Titre trop court (3+ caract√®res)", "error");
            return;
        }
        
        // Afficher le loader
        publishBtn.innerText = 'PUBLICATION...';
        loader.classList.add('active');
        this.state.isUploading = true;
        
        // Simuler l'upload
        setTimeout(() => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const post = {
                    id: Date.now(),
                    author: this.state.session.pseudo,
                    authorPfp: this.state.session.pfp,
                    title: title,
                    type: file.type.includes('video') ? 'video' : 'photo',
                    content: e.target.result,
                    likes: 0,
                    likedBy: [],
                    comments: [],
                    timestamp: new Date().toISOString(),
                    views: 0
                };

                this.state.posts.unshift(post);
                this.sync();
                
                this.notify("Publication en ligne !");
                this.go('home');
                this.renderFeed();
                
                // R√©initialiser
                this.resetUploadForm();
                publishBtn.innerText = 'PUBLIER';
                loader.classList.remove('active');
                this.state.isUploading = false;
            };
            reader.readAsDataURL(file);
        }, 1500);
    },

    // --- RENDER POST ---
    renderPost(p) {
        const isLiked = p.likedBy.includes(this.state.session.pseudo);
        const isSubscribed = this.isSubscribed(p.author);
        
        return `
            <div class="post" data-id="${p.id}">
                <div class="post-head">
                    <div class="user-info">
                        <img src="${p.authorPfp}" alt="${p.author}">
                        <div class="user-meta">
                            <h4>${p.author}</h4>
                            <span>${this.formatTime(p.timestamp)} ‚Ä¢ ${p.views} vues</span>
                        </div>
                    </div>
                    <button class="subscribe-btn ${isSubscribed ? 'subscribed' : ''}" onclick="App.toggleSubscribe('${p.author}')">
                        ${isSubscribed ? 'Abonn√©' : "S'abonner"}
                    </button>
                </div>
                <div class="post-media" ondblclick="App.likePost(${p.id})" onclick="App.viewPost(${p.id})">
                    ${p.type === 'photo' ? 
                        `<img src="${p.content}" alt="${p.title}">` : 
                        `<video src="${p.content}" controls></video>`
                    }
                </div>
                <div class="post-actions">
                    <i class="fa-heart ${isLiked ? 'fas active' : 'far'} action-btn" onclick="App.likePost(${p.id})" title="Aimer"></i>
                    <i class="far fa-comment action-btn" onclick="App.focusComment(${p.id})" title="Commenter"></i>
                    <i class="far fa-share-square action-btn" onclick="App.sharePost(${p.id})" title="Partager"></i>
                    <i class="fas fa-ellipsis-v action-btn" onclick="App.postOptions(${p.id})" title="Options"></i>
                </div>
                <div class="post-details">
                    <span class="likes-count">${p.likes} mentions J'aime</span>
                    <div class="caption"><b>${p.author}</b> ${p.title}</div>
                    ${p.comments && p.comments.length > 0 ? `
                        <div style="margin-top:10px; color:var(--text-dim); font-size:13px;">
                            ${p.comments.slice(0, 2).map(c => `
                                <div><b>${c.user}</b> ${c.text} <span style="font-size:11px;">${c.time}</span></div>
                            `).join('')}
                            ${p.comments.length > 2 ? `<div style="cursor:pointer;" onclick="App.viewComments(${p.id})">Voir les ${p.comments.length - 2} commentaires suppl√©mentaires</div>` : ''}
                        </div>
                    ` : ''}
                    <div style="margin-top:10px; display:flex;">
                        <input type="text" id="comment-${p.id}" placeholder="Ajouter un commentaire..." style="flex:1; background:none; border:none; border-bottom:1px solid var(--border); padding:5px 0; color:white; outline:none;">
                        <button onclick="App.addComment(${p.id})" style="background:none; border:none; color:var(--accent); cursor:pointer; font-weight:700; margin-left:10px;">Publier</button>
                    </div>
                </div>
            </div>
        `;
    },

    // --- RENDER FEED ---
    renderFeed() {
        const feed = document.getElementById('main-feed');
        if(this.state.posts.length === 0) {
            feed.innerHTML = `
                <div style="text-align:center; padding:50px; color:var(--text-dim);">
                    <i class="fas fa-photo-video" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Le flux est vide. Soyez le premier √† publier !</p>
                    <button onclick="App.go('upload')" style="margin-top:15px; padding:12px 25px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
                        <i class="fas fa-plus"></i> Cr√©er ma premi√®re publication
                    </button>
                </div>`;
            return;
        }

        feed.innerHTML = this.state.posts.map(p => this.renderPost(p)).join('');
    },

    // --- RENDER DISCOVER ---
    renderDiscover() {
        const grid = document.getElementById('discover-grid');
        const trendingPosts = [...this.state.posts]
            .sort((a, b) => b.likes - a.likes)
            .slice(0, 9);
        
        if(trendingPosts.length === 0) {
            grid.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-dim);">
                    <i class="fas fa-fire" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Aucune tendance pour le moment</p>
                    <p style="font-size:13px;">Les posts avec le plus de likes appara√Ætront ici</p>
                </div>`;
            return;
        }
        
        grid.innerHTML = trendingPosts.map(p => `
            <div style="aspect-ratio:1; background:#111; border-radius:8px; overflow:hidden; position:relative; cursor:pointer" onclick="App.viewPost(${p.id})">
                ${p.type === 'photo' ? 
                    `<img src="${p.content}" style="width:100%; height:100%; object-fit:cover;">` : 
                    `<video src="${p.content}" style="width:100%; height:100%; object-fit:cover;"></video>
                     <i class="fas fa-play" style="position:absolute; top:10px; right:10px; color:white; background:rgba(0,0,0,0.5); padding:5px; border-radius:50%; font-size:12px;"></i>`
                }
                <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.8)); padding:8px; color:white; font-size:11px;">
                    <i class="fas fa-heart" style="color:var(--accent); margin-right:5px;"></i> ${p.likes}
                </div>
            </div>
        `).join('');
    },

    // --- RENDER PROFILE ---
    renderProfile() {
        const myPosts = this.state.posts.filter(p => p.author === this.state.session.pseudo);
        document.getElementById('count-posts').innerText = myPosts.length;
        
        // Calculer les stats d'abonnements
        const userSubscriptions = this.state.subscriptions[this.state.session.pseudo] || { followers: [], following: [] };
        document.getElementById('count-followers').innerText = userSubscriptions.followers.length;
        document.getElementById('count-following').innerText = userSubscriptions.following.length;
        
        const grid = document.getElementById('profile-grid');
        if(myPosts.length === 0) {
            grid.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-dim);">
                    <i class="fas fa-camera" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Aucune publication pour le moment</p>
                    <button onclick="App.go('upload')" style="margin-top:15px; padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
                        Publier mon premier contenu
                    </button>
                </div>`;
            return;
        }
        
        grid.innerHTML = myPosts.map(p => `
            <div style="aspect-ratio:1; background:#111; border-radius:8px; overflow:hidden; position:relative; cursor:pointer" onclick="App.viewPost(${p.id})">
                ${p.type === 'photo' ? 
                    `<img src="${p.content}" style="width:100%; height:100%; object-fit:cover;">` : 
                    `<video src="${p.content}" style="width:100%; height:100%; object-fit:cover;"></video>
                     <i class="fas fa-play" style="position:absolute; top:8px; right:8px; color:white; background:rgba(0,0,0,0.7); padding:5px; border-radius:50%; font-size:10px;"></i>`
                }
                <div style="position:absolute; bottom:5px; left:5px; color:white; font-size:10px; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:3px;">
                    <i class="fas fa-heart"></i> ${p.likes}
                </div>
            </div>
        `).join('');
    },

    // --- VIEW POST MODAL ---
    viewPost(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        // Augmenter le compteur de vues
        post.views = (post.views || 0) + 1;
        this.sync();
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${post.authorPfp}" style="width:40px; height:40px; border-radius:50%;">
                        <div>
                            <h4 style="margin:0;">${post.author}</h4>
                            <small style="color:var(--text-dim);">${this.formatTime(post.timestamp)}</small>
                        </div>
                    </div>
                    <i class="fas fa-times" style="cursor:pointer; font-size:20px;" onclick="this.closest('.modal').remove()"></i>
                </div>
                <div style="max-height:70vh; overflow-y:auto;">
                    <div class="post-media">
                        ${post.type === 'photo' ? 
                            `<img src="${post.content}" style="width:100%; max-height:60vh; object-fit:contain;">` : 
                            `<video src="${post.content}" controls style="width:100%; max-height:60vh;"></video>`
                        }
                    </div>
                    <div style="padding:20px;">
                        <div style="display:flex; gap:20px; margin-bottom:15px; font-size:20px;">
                            <i class="fa-heart ${post.likedBy.includes(this.state.session.pseudo) ? 'fas active' : 'far'}" style="cursor:pointer;" onclick="App.likePost(${post.id}); this.closest('.modal').remove();"></i>
                            <i class="far fa-comment" style="cursor:pointer;"></i>
                            <i class="far fa-share-square" style="cursor:pointer;" onclick="App.sharePost(${post.id})"></i>
                        </div>
                        <div style="margin-bottom:10px;">
                            <strong style="color:var(--accent);">${post.likes} mentions J'aime ‚Ä¢ ${post.views} vues</strong>
                        </div>
                        <p><b>${post.author}</b> ${post.title}</p>
                        ${post.comments && post.comments.length > 0 ? `
                            <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;">
                                <h4 style="margin-bottom:10px;">Commentaires (${post.comments.length})</h4>
                                ${post.comments.map(c => `
                                    <div style="margin-bottom:10px; padding:10px; background:var(--bg-input); border-radius:10px;">
                                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                                            <img src="${this.getUserPfp(c.user)}" style="width:24px; height:24px; border-radius:50%;">
                                            <b>${c.user}</b>
                                            <small style="color:var(--text-dim);">${c.time}</small>
                                        </div>
                                        <div>${c.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if(e.target === modal) modal.remove();
        });
    },

    // --- GESTION DES ABONNEMENTS ---
    isSubscribed(user) {
        const userSubscriptions = this.state.subscriptions[this.state.session.pseudo] || { followers: [], following: [] };
        return userSubscriptions.following.includes(user);
    },

    toggleSubscribe(user) {
        if(user === this.state.session.pseudo) {
            this.notify("Vous ne pouvez pas vous abonner √† vous-m√™me", "warning");
            return;
        }
        
        // Initialiser les abonnements si n√©cessaire
        if(!this.state.subscriptions[this.state.session.pseudo]) {
            this.state.subscriptions[this.state.session.pseudo] = { followers: [], following: [] };
        }
        if(!this.state.subscriptions[user]) {
            this.state.subscriptions[user] = { followers: [], following: [] };
        }
        
        const userSubs = this.state.subscriptions[this.state.session.pseudo];
        const targetSubs = this.state.subscriptions[user];
        
        if(this.isSubscribed(user)) {
            // Se d√©sabonner
            userSubs.following = userSubs.following.filter(u => u !== user);
            targetSubs.followers = targetSubs.followers.filter(u => u !== this.state.session.pseudo);
            this.notify(`Vous vous √™tes d√©sabonn√© de ${user}`, "info");
        } else {
            // S'abonner
            userSubs.following.push(user);
            targetSubs.followers.push(this.state.session.pseudo);
            this.notify(`Vous √™tes maintenant abonn√© √† ${user} !`, "success");
        }
        
        this.sync();
        this.renderFeed();
        
        // Mettre √† jour le profil si actif
        if(this.state.activeSection === 'profile') {
            this.renderProfile();
        }
    },

    // --- GESTION DES LIKES ---
    likePost(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        const index = post.likedBy.indexOf(this.state.session.pseudo);
        
        if(index === -1) {
            post.likes++;
            post.likedBy.push(this.state.session.pseudo);
            this.notify("Publication aim√©e !", "success");
        } else {
            post.likes--;
            post.likedBy.splice(index, 1);
            this.notify("Like retir√©", "info");
        }
        
        this.sync();
        this.renderFeed();
        
        // Mettre √† jour la discover si active
        if(this.state.activeSection === 'discover') {
            this.renderDiscover();
        }
    },

    // --- GESTION DES COMMENTAIRES ---
    addComment(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        const input = document.getElementById(`comment-${id}`);
        const text = input.value.trim();
        
        if(!text) {
            this.notify("Le commentaire ne peut pas √™tre vide", "warning");
            return;
        }
        
        if(!post.comments) post.comments = [];
        
        post.comments.push({
            user: this.state.session.pseudo,
            text: text,
            time: '√Ä l\'instant'
        });
        
        this.sync();
        this.renderFeed();
        this.notify("Commentaire ajout√© !", "success");
        input.value = "";
    },

    viewComments(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post || !post.comments || post.comments.length === 0) return;
        
        const commentList = post.comments.map(c => `${c.user}: ${c.text}`).join('\n');
        alert(`Tous les commentaires:\n\n${commentList}`);
    },

    focusComment(id) {
        const input = document.getElementById(`comment-${id}`);
        if(input) input.focus();
    },

    // --- PARTAGE DE POSTS ---
    sharePost(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        // Simuler le partage
        const shareUrl = `rasstube://post/${id}`;
        const shareText = `Regarde cette publication de ${post.author} sur Rasstube: "${post.title}"`;
        
        if(navigator.share) {
            navigator.share({
                title: 'Rasstube',
                text: shareText,
                url: window.location.href
            }).then(() => {
                this.notify("Publication partag√©e !", "success");
            }).catch(err => {
                console.log('Erreur de partage:', err);
                this.copyToClipboard(shareUrl);
            });
        } else {
            this.copyToClipboard(shareUrl);
        }
    },

    copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            this.notify("Lien copi√© dans le presse-papier !", "success");
        }).catch(err => {
            console.error('Erreur de copie:', err);
            prompt("Copiez ce lien:", text);
            this.notify("Lien copi√© !", "success");
        });
    },

    // --- OPTIONS DE POST ---
    postOptions(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        const options = post.author === this.state.session.pseudo ? 
            ["Supprimer", "Modifier", "Partager", "Annuler"] : 
            ["Signaler", "Partager", "Annuler"];
        
        const choice = prompt(`Options pour ${post.author}:\n${options.join('\n')}\n\nEntrez votre choix:`);
        
        if(choice === "Supprimer" && post.author === this.state.session.pseudo) {
            if(confirm("Voulez-vous vraiment supprimer cette publication?")) {
                this.state.posts = this.state.posts.filter(p => p.id !== id);
                this.sync();
                this.renderFeed();
                this.notify("Publication supprim√©e", "success");
            }
        } else if(choice === "Signaler") {
            this.notify("Publication signal√©e aux mod√©rateurs", "warning");
        } else if(choice === "Partager") {
            this.sharePost(id);
        } else if(choice === "Modifier") {
            const newTitle = prompt("Nouveau titre:", post.title);
            if(newTitle && newTitle.trim()) {
                post.title = newTitle.trim();
                this.sync();
                this.renderFeed();
                this.notify("Publication modifi√©e", "success");
            }
        }
    },

    // --- CHAT IA ---
    openAIChat() {
        const question = prompt("Bonjour ! Je suis l'IA Rasstube. Posez-moi n'importe quelle question :");
        
        if(question && question.trim()) {
            // R√©ponse instantan√©e de l'IA
            const response = this.getAIResponse(question);
            
            // Afficher la question et la r√©ponse
            const chatWindow = `
                <div style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--bg-card); border-radius:20px; padding:30px; max-width:500px; width:90%; z-index:2001; box-shadow:0 20px 60px rgba(0,0,0,0.8); border:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-robot" style="color:var(--ai-color);"></i>
                            Assistant IA
                        </h3>
                        <i class="fas fa-times" onclick="this.parentElement.parentElement.remove()" style="cursor:pointer; color:var(--text-dim);"></i>
                    </div>
                    
                    <div style="background:var(--bg-input); padding:15px; border-radius:15px; margin-bottom:15px;">
                        <div style="display:flex; align-items:flex-start; gap:10px;">
                            <img src="${this.state.session.pfp}" style="width:30px; height:30px; border-radius:50%; border:2px solid var(--accent);">
                            <div>
                                <b style="color:var(--accent);">Vous</b>
                                <p style="margin:5px 0 0;">${question}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-elevated); padding:15px; border-radius:15px; border-left:4px solid var(--ai-color);">
                        <div style="display:flex; align-items:flex-start; gap:10px;">
                            <i class="fas fa-robot" style="color:var(--ai-color); font-size:24px;"></i>
                            <div>
                                <b style="color:var(--ai-color);">IA Rasstube</b>
                                <p style="margin:5px 0 0;">${response}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button onclick="App.askAIQuick('Comment gagner des abonn√©s ?')" style="background:var(--bg-input); border:1px solid var(--border); color:white; padding:8px 15px; border-radius:10px; cursor:pointer; font-size:13px;">
                            üí° Gagner des abonn√©s
                        </button>
                        <button onclick="App.askAIQuick('Quand publier ?')" style="background:var(--bg-input); border:1px solid var(--border); color:white; padding:8px 15px; border-radius:10px; cursor:pointer; font-size:13px;">
                            ‚è∞ Meilleur moment
                        </button>
                        <button onclick="App.askAIQuick('Conseils contenu')" style="background:var(--bg-input); border:1px solid var(--border); color:white; padding:8px 15px; border-radius:10px; cursor:pointer; font-size:13px;">
                            üéØ Conseils contenu
                        </button>
                    </div>
                    
                    <button onclick="this.parentElement.remove()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:15px; font-weight:700; cursor:pointer; margin-top:20px;">
                        Fermer
                    </button>
                </div>
                <div style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000;" onclick="this.remove(); this.previousElementSibling.remove()"></div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', chatWindow);
        }
    },

    getAIResponse(question) {
        const lowerQuestion = question.toLowerCase();
        
        // R√©ponses programm√©es selon les mots-cl√©s
        if(lowerQuestion.includes('abonn√©') || lowerQuestion.includes('follower')) {
            return "Pour gagner des abonn√©s : Publiez r√©guli√®rement du contenu de qualit√©, interagissez avec les commentaires, utilisez des hashtags pertinents et collaborez avec d'autres cr√©ateurs. La constance est la cl√© !";
        }
        else if(lowerQuestion.includes('heure') || lowerQuestion.includes('moment') || lowerQuestion.includes('publier')) {
            return "Les meilleurs moments pour publier sont g√©n√©ralement entre 18h et 21h en semaine, et entre 11h et 14h le week-end. Testez diff√©rentes heures pour voir ce qui fonctionne le mieux avec votre audience !";
        }
        else if(lowerQuestion.includes('conseil') || lowerQuestion.includes('astuce')) {
            return "Conseils : 1) Soignez la premi√®re seconde de vos vid√©os 2) Utilisez des miniatures attractives 3) R√©pondez aux commentaires 4) Soyez authentique 5) Analysez vos statistiques pour vous am√©liorer.";
        }
        else if(lowerQuestion.includes('like') || lowerQuestion.includes('engagement')) {
            return "Pour augmenter l'engagement : Posez des questions dans vos l√©gendes, cr√©ez du contenu interactif (sondages, Q&A), r√©pondez rapidement aux commentaires, et organisez des concours occasionnellement.";
        }
        else if(lowerQuestion.includes('vid√©o') || lowerQuestion.includes('photo')) {
            return "Pour un contenu optimal : Utilisez un bon √©clairage (lumi√®re naturelle si possible), un son clair, stabilisez votre cam√©ra, et √©ditez pour garder un rythme dynamique. La qualit√© technique est importante !";
        }
        else if(lowerQuestion.includes('salut') || lowerQuestion.includes('bonjour') || lowerQuestion.includes('hello')) {
            return `Bonjour ${this.state.session.pseudo} ! Heureux de vous aider aujourd'hui. Posez-moi n'importe quelle question sur Rasstube, le growth hacking, ou la cr√©ation de contenu !`;
        }
        else {
            // R√©ponse al√©atoire parmi les r√©ponses programm√©es
            const randomIndex = Math.floor(Math.random() * this.state.aiResponses.length);
            return this.state.aiResponses[randomIndex];
        }
    },

    askAIQuick(question) {
        const response = this.getAIResponse(question);
        alert(`ü§ñ IA Rasstube:\n\n${response}`);
    },

    // --- MESSAGERIE ---
    showMessages() {
        const users = this.state.users.filter(u => u.pseudo !== this.state.session.pseudo);
        
        let usersList = users.map(u => `${u.pseudo} (${u.followers || 0} abonn√©s)`).join('\n');
        if(!usersList) usersList = "Aucun autre utilisateur pour le moment";
        
        const message = prompt(`Envoyer un message √† :\n\n${usersList}\n\nEntrez le pseudo et le message (format: pseudo|message):`);
        
        if(message) {
            const parts = message.split('|');
            if(parts.length >= 2) {
                const targetUser = parts[0].trim();
                const msgText = parts.slice(1).join('|').trim();
                
                if(this.state.users.find(u => u.pseudo === targetUser)) {
                    // Envoyer le message
                    this.state.messages.push({
                        from: this.state.session.pseudo,
                        to: targetUser,
                        text: msgText,
                        time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                        read: false
                    });
                    
                    this.sync();
                    this.notify(`Message envoy√© √† ${targetUser} !`, "success");
                    
                    // R√©ponse automatique apr√®s 2 secondes
                    setTimeout(() => {
                        const autoResponses = [
                            "Merci pour votre message ! Je vous r√©pondrai d√®s que possible.",
                            "Message re√ßu ! Je suis actuellement occup√©, je reviens vers vous rapidement.",
                            "Merci de votre int√©r√™t ! Comment puis-je vous aider aujourd'hui ?"
                        ];
                        const randomResponse = autoResponses[Math.floor(Math.random() * autoResponses.length)];
                        
                        this.state.messages.push({
                            from: targetUser,
                            to: this.state.session.pseudo,
                            text: randomResponse,
                            time: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'}),
                            read: false
                        });
                        
                        this.sync();
                        this.notify(`Nouveau message de ${targetUser} !`, "info");
                    }, 2000);
                } else {
                    this.notify(`Utilisateur "${targetUser}" introuvable`, "error");
                }
            } else {
                this.notify("Format incorrect. Utilisez: pseudo|message", "error");
            }
        }
    },

    // --- UTILS ---
    formatTime(timestamp) {
        if(!timestamp) return "√Ä l'instant";
        
        const now = new Date();
        const postDate = new Date(timestamp);
        const diff = now - postDate;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if(minutes < 1) return "√Ä l'instant";
        if(minutes < 60) return `Il y a ${minutes} min`;
        if(hours < 24) return `Il y a ${hours} h`;
        if(days < 7) return `Il y a ${days} j`;
        return postDate.toLocaleDateString('fr-FR');
    },

    getUserPfp(username) {
        const user = this.state.users.find(u => u.pseudo === username);
        return user ? user.pfp : 'https://api.dicebear.com/7.x/avataaars/svg?seed=User';
    },

    notify(msg, type = "success") {
        const box = document.getElementById('notification-box');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="fas ${icons[type] || 'fa-info-circle'}" style="color:${type === 'success' ? 'var(--success)' : type === 'error' ? '#ff4444' : type === 'warning' ? 'var(--warning)' : 'var(--ai-color)'}"></i>
            <div>
                <strong style="font-size:14px;">${type.toUpperCase()}</strong>
                <p style="margin:5px 0 0; font-size:14px;">${msg}</p>
            </div>
        `;
        
        box.appendChild(toast);
        
        // Auto-remove
        setTimeout(() => {
            toast.style.animation = 'slideInRight 0.5s ease reverse';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    },

    renderAvatars() {
        const grid = document.getElementById('default-avatars');
        const seeds = ['Felix', 'Aneka', 'Rass', 'Shadow', 'Neo', 'Luna', 'Nova', 'Pulse', 'Zen', 'Vortex', 'Orion', 'Stella'];
        grid.innerHTML = seeds.map(s => {
            const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}`;
            return `
                <div class="pfp-item ${this.state.selectedPfp === url ? 'selected' : ''}" onclick="App.selectPfp('${url}')">
                    <img src="${url}" alt="${s}">
                </div>
            `;
        }).join('');
    },

    selectPfp(url) {
        this.state.selectedPfp = url;
        document.getElementById('auth-pfp-preview').src = url;
        this.renderAvatars();
    },

    handlePfpFile(e) {
        const file = e.target.files[0];
        if(!file) return;
        
        if(!file.type.includes('image')) {
            this.notify("Veuillez s√©lectionner une image", "error");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            this.state.selectedPfp = event.target.result;
            document.getElementById('auth-pfp-preview').src = event.target.result;
            this.notify("Photo de profil mise √† jour", "success");
        };
        reader.readAsDataURL(file);
    },

    triggerPfpUpload() { 
        document.getElementById('real-pfp-input').click(); 
    },

    logout() {
        if(confirm("Voulez-vous vraiment vous d√©connecter de Rasstube ?")) {
            this.state.session = null;
            this.sync();
            location.reload();
        }
    }
};

// INITIALISATION
window.onload = () => App.init();

// Drag and drop pour upload
document.addEventListener('DOMContentLoaded', () => {
    const dropzone = document.getElementById('upload-dropzone');
    if(dropzone) {
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--accent)';
            dropzone.style.background = 'var(--accent-soft)';
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = 'var(--border)';
            dropzone.style.background = '';
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--border)';
            dropzone.style.background = '';
            
            const file = e.dataTransfer.files[0];
            if(file && (file.type.includes('image') || file.type.includes('video'))) {
                const input = document.getElementById('file-upload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                
                // D√©clencher l'√©v√©nement change
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
                
                App.notify('Fichier import√© avec succ√®s !', 'success');
            } else {
                App.notify('Format de fichier non support√©', 'error');
            }
        });
    }
});
</script>
</body>
</html>