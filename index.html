<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RASSTUBE ULTIMATE | v4.0 Elite Ecosystem</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #FF0032;
            --accent-soft: rgba(255, 0, 50, 0.15);
            --accent-glow: rgba(255, 0, 50, 0.5);
            --bg-deep: #050505;
            --bg-card: #0F0F0F;
            --bg-elevated: #1A1A1A;
            --bg-input: #121212;
            --text-main: #FFFFFF;
            --text-dim: #909090;
            --border: rgba(255, 255, 255, 0.08);
            --ai-color: #00D1FF;
            --success: #00FF85;
            --warning: #FFAA00;
            --radius-xl: 32px;
            --radius-lg: 20px;
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.6);
            --transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-deep); color: var(--text-main); 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden; -webkit-user-select: none;
            min-height: 100vh;
        }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseAccent { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 50, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 50, 0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- AUTHENTIFICATION ENGINE --- */
        #auth-portal {
            position: fixed; inset: 0; z-index: 9999; 
            background: radial-gradient(circle at top right, #1a0505, #000);
            display: flex; align-items: center; justify-content: center; padding: 25px;
        }

        .auth-container {
            width: 100%; max-width: 440px; background: var(--bg-card);
            border-radius: var(--radius-xl); border: 1px solid var(--border);
            padding: 45px 35px; box-shadow: var(--shadow-lg);
            animation: fadeIn 0.8s ease;
        }

        .auth-tabs {
            display: flex; background: var(--bg-input); padding: 6px;
            border-radius: 18px; margin-bottom: 35px; border: 1px solid var(--border);
        }

        .auth-tabs button {
            flex: 1; padding: 14px; border: none; background: none;
            color: var(--text-dim); font-weight: 700; cursor: pointer;
            border-radius: 14px; transition: var(--transition);
        }

        .auth-tabs button.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); }

        .input-box { margin-bottom: 22px; position: relative; }
        .input-box i { position: absolute; left: 18px; top: 18px; color: var(--text-dim); font-size: 18px; }
        .input-control {
            width: 100%; padding: 18px 18px 18px 52px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 18px; color: white;
            font-size: 15px; transition: var(--transition);
        }
        .input-control:focus { border-color: var(--accent); outline: none; background: #161616; }

        .pfp-selector { text-align: center; margin-bottom: 25px; }
        .pfp-main-preview {
            width: 110px; height: 110px; border-radius: 50%;
            border: 3px solid var(--accent); padding: 4px; object-fit: cover;
            margin-bottom: 15px; transition: var(--transition);
        }
        .pfp-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px;
        }
        .pfp-item {
            aspect-ratio: 1; border-radius: 14px; overflow: hidden; cursor: pointer;
            border: 2px solid transparent; transition: var(--transition);
        }
        .pfp-item.selected { border-color: var(--accent); transform: scale(1.1); }
        .pfp-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- CORE APP LAYOUT --- */
        #main-app { display: none; padding-bottom: 100px; min-height: 100vh; }

        .top-nav {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(25px);
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }

        .nav-wrapper {
            max-width: 1200px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
        }

        .brand { font-size: 28px; font-weight: 900; color: var(--accent); letter-spacing: -1.5px; }

        .search-bar {
            background: var(--bg-elevated); border-radius: 14px;
            padding: 10px 18px; display: flex; align-items: center;
            width: 40%; border: 1px solid var(--border);
        }
        .search-bar input { background: none; border: none; color: white; margin-left: 10px; width: 100%; outline: none; }

        /* --- SECTIONS --- */
        .content-container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* Stories */
        .story-scroller {
            display: flex; gap: 18px; overflow-x: auto; padding: 10px 0 25px;
            scrollbar-width: none;
        }
        .story-scroller::-webkit-scrollbar { display: none; }
        .story-card {
            flex-shrink: 0; width: 85px; text-align: center; cursor: pointer;
        }
        .story-ring {
            width: 78px; height: 78px; border-radius: 50%; padding: 3px;
            background: linear-gradient(45deg, #FF0032, #FF8A00);
            margin-bottom: 8px; transition: var(--transition);
        }
        .story-card img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--bg-deep); object-fit: cover; }
        .story-card:active .story-ring { transform: scale(0.9); }
        .story-label { font-size: 11px; font-weight: 600; color: var(--text-dim); }

        /* Post Card */
        .post {
            background: var(--bg-card); border-radius: var(--radius-lg);
            margin-bottom: 35px; border: 1px solid var(--border);
            overflow: hidden; animation: fadeIn 0.6s ease;
        }
        .post-head { padding: 18px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 14px; }
        .user-info img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .user-meta h4 { margin: 0; font-size: 15px; font-weight: 700; }
        .user-meta span { font-size: 11px; color: var(--text-dim); }

        .post-media { width: 100%; background: #000; position: relative; cursor: pointer; }
        .post-media img, .post-media video { width: 100%; display: block; max-height: 650px; object-fit: contain; }

        .post-actions { padding: 15px 20px; display: flex; gap: 25px; font-size: 24px; }
        .action-btn { cursor: pointer; transition: var(--transition); color: var(--text-main); }
        .action-btn:active { transform: scale(1.3); }
        .action-btn.active { color: var(--accent); }

        .post-details { padding: 0 20px 20px; }
        .likes-count { font-weight: 800; font-size: 14px; margin-bottom: 8px; display: block; }
        .caption { font-size: 14px; line-height: 1.5; }
        .caption b { margin-right: 8px; color: var(--accent); }

        /* --- BOTTOM NAV --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(30px);
            border-top: 1px solid var(--border); padding: 12px 10px 32px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
        }
        .nav-item { 
            color: var(--text-dim); text-align: center; 
            flex: 1; transition: var(--transition); cursor: pointer; 
            position: relative;
        }
        .nav-item.active { color: var(--accent); transform: translateY(-5px); }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

        .fab-upload {
            background: var(--accent); width: 60px; height: 60px;
            border-radius: 22px; display: flex; align-items: center; justify-content: center;
            margin-top: -45px; border: 6px solid var(--bg-deep);
            color: white !important; font-size: 26px !important;
            animation: pulseAccent 2s infinite;
            cursor: pointer;
        }
        .fab-upload.active { background: var(--success); }

        /* --- MODALS & OVERLAYS --- */
        .modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.95); display: none;
            padding: 20px; overflow-y: auto;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: var(--bg-card); border-radius: var(--radius-lg);
            max-width: 800px; width: 100%; overflow: hidden;
        }
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 20px; border-bottom: 1px solid var(--border);
        }
        .modal-header h3 { margin: 0; }

        /* --- TOAST SYSTEM --- */
        #notification-box {
            position: fixed; top: 25px; right: 25px; z-index: 10000;
            max-width: 350px;
        }
        .toast {
            background: var(--bg-elevated); border-left: 4px solid var(--accent);
            padding: 18px 25px; border-radius: 14px; margin-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center;
            gap: 15px; animation: slideInRight 0.5s ease;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: #ff4444; }
        .toast.warning { border-left-color: var(--warning); }

        /* --- LOADER --- */
        .loader {
            width: 30px; height: 30px; border: 3px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none;
        }
        .loader.active { display: inline-block; }

        /* --- CHAT STYLES --- */
        .chat-message {
            margin-bottom: 15px; padding: 15px; border-radius: 15px;
            max-width: 85%; word-wrap: break-word;
        }
        .user-message {
            background: var(--accent-soft); border: 1px solid var(--accent);
            margin-left: auto; align-self: flex-end;
        }
        .ai-message {
            background: var(--bg-elevated); border-left: 4px solid var(--ai-color);
            margin-right: auto; align-self: flex-start;
        }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .visible { display: block !important; }
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .nav-wrapper { flex-wrap: wrap; gap: 15px; }
            .search-bar { width: 100%; order: 3; }
            .content-container { padding: 15px; }
            .auth-container { padding: 35px 25px; }
            .pfp-grid { grid-template-columns: repeat(3, 1fr); }
            .bottom-bar { padding: 12px 5px 32px; }
            .nav-item i { font-size: 22px; }
            .nav-item span { font-size: 9px; }
            .modal-content { margin: 10px; }
        }

        @media (max-width: 480px) {
            .brand { font-size: 24px; }
            .post-actions { font-size: 22px; gap: 20px; }
            .story-card { width: 70px; }
            .story-ring { width: 65px; height: 65px; }
        }
    </style>
</head>
<body>

<div id="notification-box"></div>

<div id="auth-portal">
    <div class="auth-container">
        <div class="brand text-center" style="margin-bottom: 35px; font-size: 42px;">RASSTUBE</div>
        
        <div class="auth-tabs">
            <button id="tab-login" class="active" onclick="App.toggleAuth('login')">CONNEXION</button>
            <button id="tab-signup" onclick="App.toggleAuth('signup')">INSCRIPTION</button>
        </div>

        <div id="signup-profile-setup" class="hidden">
            <div class="pfp-selector">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Rass" class="pfp-main-preview" id="auth-pfp-preview">
                <div class="mt-20">
                    <button onclick="App.triggerPfpUpload()" style="background:var(--accent-soft); color:var(--accent); border:none; padding:10px 20px; border-radius:12px; font-weight:700; cursor:pointer;">
                        <i class="fas fa-camera"></i> MA PHOTO
                    </button>
                </div>
                <input type="file" id="real-pfp-input" class="hidden" accept="image/*" onchange="App.handlePfpFile(event)">
                
                <div class="pfp-grid" id="default-avatars"></div>
            </div>
            
            <div class="input-box">
                <i class="fas fa-user-tag"></i>
                <input type="text" id="reg-pseudo" class="input-control" placeholder="Ton Pseudo Elite">
            </div>
        </div>

        <div class="input-box">
            <i class="fas fa-envelope"></i>
            <input type="email" id="auth-email" class="input-control" placeholder="Adresse e-mail">
        </div>
        
        <div class="input-box">
            <i class="fas fa-lock"></i>
            <input type="password" id="auth-pass" class="input-control" placeholder="Mot de passe (6+ caract√®res)">
        </div>

        <button onclick="App.executeAuth()" id="auth-btn" style="width: 100%; padding: 22px; background: var(--accent); color: white; border: none; border-radius: 20px; font-weight: 800; font-size: 16px; margin-top: 15px; cursor: pointer; transition: 0.3s;">
            <span id="auth-btn-text">REJOINDRE LE R√âSEAU</span>
            <div class="loader" id="auth-loader"></div>
        </button>
        
        <p id="auth-msg" style="text-align: center; color: #ff4444; font-size: 13px; margin-top: 20px; display: none;"></p>
    </div>
</div>

<div id="main-app">
    <header class="top-nav">
        <div class="nav-wrapper">
            <div class="brand">RASSTUBE</div>
            <div class="search-bar">
                <i class="fas fa-search" style="color:var(--text-dim)"></i>
                <input type="text" id="search-input" placeholder="Rechercher sur le r√©seau..." onkeyup="App.filterContent(this.value)">
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <i class="fas fa-paper-plane" style="font-size: 20px; cursor: pointer;" title="Messages"></i>
                <img src="" id="user-pfp-top" style="width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent); cursor: pointer;" onclick="App.go('profile')" alt="Profil">
            </div>
        </div>
    </header>

    <main class="content-container">
        <section id="sec-home" class="app-section">
            <div class="story-scroller" id="story-container"></div>
            <div id="main-feed"></div>
        </section>

        <section id="sec-discover" class="app-section hidden">
            <h2 style="margin-bottom: 25px;">Tendances <i class="fas fa-fire" style="color:var(--accent)"></i></h2>
            <div id="discover-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;"></div>
        </section>

        <section id="sec-chat" class="app-section hidden">
            <div style="background: var(--bg-card); border-radius: var(--radius-lg); height: calc(100vh - 280px); display: flex; flex-direction: column;">
                <div id="chat-header" style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <h3 style="margin: 0;"><i class="fas fa-robot" style="color:var(--ai-color)"></i> Assistant IA Rasstube</h3>
                    <p style="margin: 5px 0 0; color: var(--text-dim); font-size: 14px;">Posez-moi n'importe quelle question</p>
                </div>
                <div id="chat-messages" style="flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column;"></div>
                <div style="padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 12px;">
                    <input type="text" id="ai-input" class="input-control" placeholder="Demande n'importe quoi √† l'IA..." style="margin: 0; padding-left: 20px;" onkeyup="if(event.key === 'Enter') App.askAI()">
                    <button onclick="App.askAI()" style="background: var(--accent); border: none; width: 60px; border-radius: 15px; color: white; cursor: pointer;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="sec-upload" class="app-section hidden">
            <div class="auth-container" style="max-width: 100%; box-shadow: none; padding: 35px;">
                <h3 style="margin-top: 0; margin-bottom: 25px;"><i class="fas fa-plus-circle"></i> Nouvelle Cr√©ation</h3>
                
                <div class="input-box" style="border: 2px dashed var(--border); border-radius: 20px; padding: 40px; text-align: center; cursor: pointer;" onclick="document.getElementById('file-upload').click()" id="upload-dropzone">
                    <i class="fas fa-cloud-upload-alt" style="position: static; font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
                    <p style="margin: 0; font-weight: 700;">Clique pour importer (Vid√©o ou Photo)</p>
                    <p style="margin: 10px 0 0; font-size: 13px; color: var(--text-dim);">Max. 50MB - MP4, MOV, JPG, PNG</p>
                    <input type="file" id="file-upload" class="hidden" accept="video/*,image/*" onchange="App.previewUpload(event)">
                </div>

                <div id="upload-preview" class="hidden" style="margin: 25px 0; border-radius: 15px; overflow: hidden; position: relative;">
                    <button onclick="document.getElementById('upload-preview').classList.add('hidden'); document.getElementById('file-upload').value = '';" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">√ó</button>
                </div>

                <div class="input-box">
                    <i class="fas fa-heading"></i>
                    <input type="text" id="up-title" class="input-control" placeholder="Titre de la publication">
                </div>

                <div class="input-box">
                    <i class="fas fa-tag"></i>
                    <select id="up-type" class="input-control" style="appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23909090" d="M2 4l4 4 4-4z"/></svg>'); background-repeat: no-repeat; background-position: right 18px center; background-size: 12px;">
                        <option value="video">üé¨ Vid√©o Standard</option>
                        <option value="photo">üì∑ Photo / Image</option>
                        <option value="rshot">‚ö° RShot (Format Vertical)</option>
                    </select>
                </div>

                <button onclick="App.publishPost()" style="width: 100%; padding: 20px; background: var(--accent); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span id="publish-text">LANCER LA PUBLICATION</span>
                    <div class="loader" id="publish-loader"></div>
                </button>
            </div>
        </section>

        <section id="sec-profile" class="app-section hidden">
            <div style="text-align: center; margin-bottom: 40px;">
                <img src="" id="prof-pfp" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); padding: 5px; margin-bottom: 20px; object-fit: cover;">
                <h2 id="prof-name" style="margin: 0; font-size: 28px;">Pseudo</h2>
                <p id="prof-email" style="color: var(--text-dim); margin-top: 5px;"></p>
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 25px;">
                    <div><b style="display: block; font-size: 18px;" id="count-posts">0</b><span style="font-size: 11px; color: var(--text-dim);">POSTS</span></div>
                    <div><b style="display: block; font-size: 18px;" id="count-followers">1.4k</b><span style="font-size: 11px; color: var(--text-dim);">ABONN√âS</span></div>
                    <div><b style="display: block; font-size: 18px;" id="count-elite">320</b><span style="font-size: 11px; color: var(--text-dim);">ELITE</span></div>
                </div>
                <button onclick="App.logout()" style="margin-top: 30px; padding: 12px 25px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; color: #ff4444; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-sign-out-alt"></i> DECONNEXION
                </button>
            </div>
            <div id="profile-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
        </section>
    </main>

    <nav class="bottom-bar">
        <div class="nav-item active" onclick="App.go('home')">
            <i class="fas fa-home"></i>
            <span>Flux</span>
        </div>
        <div class="nav-item" onclick="App.go('discover')">
            <i class="fas fa-compass"></i>
            <span>Tendances</span>
        </div>
        <div class="fab-upload" onclick="App.go('upload')" id="fab-upload-btn">
            <i class="fas fa-plus"></i>
        </div>
        <div class="nav-item" onclick="App.go('chat')">
            <i class="fas fa-robot"></i>
            <span>IA Chat</span>
        </div>
        <div class="nav-item" onclick="App.go('profile')">
            <i class="fas fa-user-shield"></i>
            <span>Profil</span>
        </div>
    </nav>
</div>

<script>
/**
 * RASSTUBE CORE ENGINE v4.0 - CORRIG√â
 * Architecture : Gestion d'√©tat r√©active & Persistance locale
 */

const App = {
    // √âTAT GLOBAL
    state: {
        users: JSON.parse(localStorage.getItem('rt_v4_users') || '[]'),
        posts: JSON.parse(localStorage.getItem('rt_v4_posts') || '[]'),
        session: JSON.parse(localStorage.getItem('rt_v4_session') || 'null'),
        currentTab: 'login',
        selectedPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Rass',
        activeSection: 'home',
        isUploading: false
    },

    // INITIALISATION
    init() {
        this.verifySession();
        this.renderAvatars();
        this.sync();

        if(this.state.session) {
            this.launch();
        }
        
        // Ajouter des donn√©es par d√©faut si vide
        if(this.state.posts.length === 0) {
            this.createDefaultPosts();
        }
        
        // Pr√©venir la fermeture accidentelle
        window.addEventListener('beforeunload', (e) => {
            if(this.state.isUploading) {
                e.preventDefault();
                e.returnValue = 'Votre publication est en cours de t√©l√©chargement. Voulez-vous vraiment quitter ?';
            }
        });
    },

    // V√âRIFICATION DE SESSION
    verifySession() {
        if(this.state.session) {
            const userExists = this.state.users.find(u => u.email === this.state.session.email);
            if(!userExists) {
                this.state.session = null;
                this.sync();
            }
        }
    },

    // SYNCHRONISATION
    sync() {
        try {
            localStorage.setItem('rt_v4_users', JSON.stringify(this.state.users));
            localStorage.setItem('rt_v4_posts', JSON.stringify(this.state.posts));
            localStorage.setItem('rt_v4_session', JSON.stringify(this.state.session));
        } catch(e) {
            console.error('Erreur de sauvegarde:', e);
            this.notify('Erreur de sauvegarde des donn√©es', 'error');
        }
    },

    // CR√âATION DE POSTS PAR D√âFAUT
    createDefaultPosts() {
        const defaultPosts = [
            {
                id: 1,
                author: 'Admin',
                authorPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Admin',
                title: 'Bienvenue sur Rasstube Ultimate v4.0 !',
                type: 'photo',
                content: 'https://images.unsplash.com/photo-1611605698335-8b1569810432?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80',
                likes: 128,
                likedBy: ['Admin']
            },
            {
                id: 2,
                author: 'Elite_Crew',
                authorPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Elite',
                title: 'Nouvelle fonctionnalit√© IA disponible ! üöÄ',
                type: 'video',
                content: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                likes: 356,
                likedBy: ['Admin', 'Elite_Crew']
            }
        ];
        
        this.state.posts = defaultPosts;
        this.sync();
    },

    // --- AUTHENTIFICATION ---
    toggleAuth(tab) {
        this.state.currentTab = tab;
        document.getElementById('tab-login').classList.toggle('active', tab === 'login');
        document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
        document.getElementById('signup-profile-setup').classList.toggle('hidden', tab === 'login');
        document.getElementById('auth-btn-text').innerText = tab === 'login' ? "SE CONNECTER" : "CR√âER MON COMPTE";
        
        // R√©initialiser les messages d'erreur
        document.getElementById('auth-msg').style.display = 'none';
    },

    // VALIDATION EMAIL
    validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    },

    // EX√âCUTION AUTHENTIFICATION
    executeAuth() {
        const email = document.getElementById('auth-email').value.trim();
        const pass = document.getElementById('auth-pass').value;
        const pseudo = document.getElementById('reg-pseudo')?.value.trim() || '';
        const msg = document.getElementById('auth-msg');
        const loader = document.getElementById('auth-loader');
        
        // Validation basique
        if(!email || !pass) {
            this.notify("Veuillez remplir tous les champs", "error");
            return;
        }
        
        if(!this.validateEmail(email)) {
            msg.innerText = "Email invalide !";
            msg.style.display = 'block';
            return;
        }
        
        if(pass.length < 6) {
            msg.innerText = "Mot de passe trop court (6+ caract√®res)";
            msg.style.display = 'block';
            return;
        }
        
        // Afficher le loader
        loader.classList.add('active');
        
        // Simuler un d√©lai r√©seau
        setTimeout(() => {
            if(this.state.currentTab === 'signup') {
                if(!pseudo) { 
                    this.notify("Pseudo requis", "error"); 
                    loader.classList.remove('active');
                    return; 
                }
                
                if(pseudo.length < 3) {
                    msg.innerText = "Pseudo trop court (3+ caract√®res)";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }
                
                if(this.state.users.find(u => u.email === email)) {
                    msg.innerText = "Cet email est d√©j√† utilis√© !";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }
                
                if(this.state.users.find(u => u.pseudo === pseudo)) {
                    msg.innerText = "Ce pseudo est d√©j√† pris !";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }

                const newUser = {
                    id: Date.now(),
                    pseudo,
                    email,
                    pass,
                    pfp: this.state.selectedPfp,
                    joined: new Date().toLocaleDateString('fr-FR'),
                    followers: Math.floor(Math.random() * 1000) + 100,
                    eliteScore: Math.floor(Math.random() * 500) + 100
                };

                this.state.users.push(newUser);
                this.state.session = newUser;
                this.notify(`Compte cr√©√© avec succ√®s, ${pseudo} !`);
            } else {
                const user = this.state.users.find(u => u.email === email && u.pass === pass);
                if(!user) {
                    msg.innerText = "Email ou mot de passe incorrect";
                    msg.style.display = 'block';
                    loader.classList.remove('active');
                    return;
                }
                this.state.session = user;
                this.notify(`Heureux de vous revoir, ${user.pseudo} !`);
            }

            this.sync();
            loader.classList.remove('active');
            this.launch();
        }, 800);
    },

    // LANCEMENT APP
    launch() {
        document.getElementById('auth-portal').classList.add('hidden');
        document.getElementById('main-app').style.display = 'block';
        
        // Mettre √† jour l'interface
        document.getElementById('user-pfp-top').src = this.state.session.pfp;
        document.getElementById('prof-pfp').src = this.state.session.pfp;
        document.getElementById('prof-name').innerText = this.state.session.pseudo;
        document.getElementById('prof-email').innerText = this.state.session.email;
        document.getElementById('count-followers').innerText = this.formatNumber(this.state.session.followers);
        document.getElementById('count-elite').innerText = this.formatNumber(this.state.session.eliteScore);

        this.renderFeed();
        this.renderStories();
        this.go('home');
        
        // Initialiser le chat
        this.initChat();
    },

    // FORMATER LES NOMBRES
    formatNumber(num) {
        if(num >= 1000) return (num/1000).toFixed(1) + 'k';
        return num.toString();
    },

    // --- GESTION DES SECTIONS ---
    go(sec) {
        // Masquer toutes les sections
        document.querySelectorAll('.app-section').forEach(s => s.classList.add('hidden'));
        document.getElementById('sec-' + sec).classList.remove('hidden');
        
        // Mettre √† jour la navigation
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        
        // Mapping correct des sections
        const navIndexes = { home: 0, discover: 1, chat: 3, profile: 4 };
        if(navIndexes[sec] !== undefined) {
            document.querySelectorAll('.nav-item')[navIndexes[sec]].classList.add('active');
        }
        
        // G√©rer le bouton FAB sp√©cial
        document.getElementById('fab-upload-btn').classList.toggle('active', sec === 'upload');
        
        // Actions sp√©cifiques
        switch(sec) {
            case 'profile': 
                this.renderProfile(); 
                break;
            case 'discover': 
                this.renderDiscover(); 
                break;
            case 'upload':
                this.resetUploadForm();
                break;
            case 'chat':
                this.scrollChatToBottom();
                break;
        }
        
        this.state.activeSection = sec;
    },

    // --- FILTRE RECHERCHE ---
    filterContent(query) {
        const feed = document.getElementById('main-feed');
        if(!query.trim()) {
            this.renderFeed();
            return;
        }
        
        const filtered = this.state.posts.filter(p => 
            p.title.toLowerCase().includes(query.toLowerCase()) || 
            p.author.toLowerCase().includes(query.toLowerCase())
        );
        
        if(filtered.length === 0) {
            feed.innerHTML = `
                <div style="text-align:center; padding:50px; color:var(--text-dim);">
                    <i class="fas fa-search" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Aucun r√©sultat pour "${query}"</p>
                    <p style="font-size:13px;">Essayez d'autres mots-cl√©s</p>
                </div>`;
            return;
        }
        
        feed.innerHTML = filtered.map(p => this.renderPost(p)).join('');
    },

    // --- GESTION DES STORIES ---
    renderStories() {
        const cont = document.getElementById('story-container');
        const users = ['Rayan', 'Milo', 'Sarah', 'Ines', 'Yass', 'Leo', 'Zoe', 'Max'];
        
        cont.innerHTML = `
            <div class="story-card" onclick="App.addStory()">
                <div class="story-ring" style="background:var(--border); border:2px dashed var(--accent)">
                    <img src="${this.state.session.pfp}">
                    <div style="position:absolute; bottom:-5px; right:-5px; background:var(--accent); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:3px solid var(--bg-deep);">
                        <i class="fas fa-plus" style="font-size:10px;"></i>
                    </div>
                </div>
                <span class="story-label">Votre story</span>
            </div>
        ` + users.map(u => `
            <div class="story-card" onclick="App.viewStory('${u}')">
                <div class="story-ring"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u}"></div>
                <span class="story-label">${u}</span>
            </div>
        `).join('');
    },

    addStory() {
        this.notify('Fonctionnalit√© stories bient√¥t disponible !', 'warning');
    },

    viewStory(user) {
        this.notify(`Story de ${user} en cours de chargement...`, 'info');
    },

    // --- CR√âATION DE CONTENU ---
    previewUpload(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('upload-preview');
        
        if(!file) return;
        
        // V√©rifier la taille (50MB max)
        if(file.size > 50 * 1024 * 1024) {
            this.notify('Fichier trop volumineux (max 50MB)', 'error');
            e.target.value = '';
            return;
        }
        
        preview.innerHTML = '';
        preview.classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (event) => {
            if(file.type.includes('video')) {
                preview.innerHTML = `
                    <video src="${event.target.result}" style="width:100%; border-radius:10px;" controls autoplay muted></video>
                `;
            } else {
                preview.innerHTML = `
                    <img src="${event.target.result}" style="width:100%; border-radius:10px; max-height:400px; object-fit:cover;">
                `;
            }
        };
        reader.readAsDataURL(file);
    },

    resetUploadForm() {
        document.getElementById('up-title').value = '';
        document.getElementById('upload-preview').innerHTML = '';
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('file-upload').value = '';
        document.getElementById('up-type').value = 'video';
    },

    publishPost() {
        const fileInput = document.getElementById('file-upload');
        const file = fileInput.files[0];
        const title = document.getElementById('up-title').value.trim();
        const type = document.getElementById('up-type').value;
        const publishBtn = document.getElementById('publish-text');
        const loader = document.getElementById('publish-loader');
        
        if(!file || !title) {
            this.notify("Fichier et titre obligatoires !", "error");
            return;
        }
        
        if(title.length < 3) {
            this.notify("Titre trop court (3+ caract√®res)", "error");
            return;
        }
        
        // Afficher le loader
        publishBtn.innerText = 'PUBLICATION...';
        loader.classList.add('active');
        this.state.isUploading = true;
        
        // Simuler l'upload
        setTimeout(() => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const post = {
                    id: Date.now(),
                    author: this.state.session.pseudo,
                    authorPfp: this.state.session.pfp,
                    title: title,
                    type: type,
                    content: e.target.result,
                    likes: 0,
                    likedBy: [],
                    timestamp: new Date().toISOString(),
                    views: Math.floor(Math.random() * 1000)
                };

                this.state.posts.unshift(post);
                this.sync();
                
                this.notify("Publication en ligne !");
                this.go('home');
                this.renderFeed();
                
                // R√©initialiser
                this.resetUploadForm();
                publishBtn.innerText = 'LANCER LA PUBLICATION';
                loader.classList.remove('active');
                this.state.isUploading = false;
            };
            reader.readAsDataURL(file);
        }, 1500);
    },

    // --- RENDER POST ---
    renderPost(p) {
        const isLiked = p.likedBy.includes(this.state.session.pseudo);
        return `
            <div class="post" data-id="${p.id}">
                <div class="post-head">
                    <div class="user-info">
                        <img src="${p.authorPfp}" alt="${p.author}">
                        <div class="user-meta">
                            <h4>${p.author}</h4>
                            <span>${this.formatTime(p.timestamp)} ‚Ä¢ ${p.views} vues</span>
                        </div>
                    </div>
                    <i class="fas fa-ellipsis-v" style="color:var(--text-dim); cursor:pointer;" onclick="App.postOptions(${p.id})"></i>
                </div>
                <div class="post-media" ondblclick="App.likePost(${p.id})" onclick="App.viewPost(${p.id})">
                    ${p.type === 'photo' ? 
                        `<img src="${p.content}" alt="${p.title}">` : 
                        `<video src="${p.content}" poster="https://images.unsplash.com/photo-1611605698335-8b1569810432?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" controls></video>`
                    }
                </div>
                <div class="post-actions">
                    <i class="fa-heart ${isLiked ? 'fas active' : 'far'} action-btn" onclick="App.likePost(${p.id})"></i>
                    <i class="far fa-comment action-btn" onclick="App.focusComment(${p.id})"></i>
                    <i class="far fa-share-square action-btn" onclick="App.sharePost(${p.id})"></i>
                </div>
                <div class="post-details">
                    <span class="likes-count">${p.likes} mentions J'aime</span>
                    <div class="caption"><b>${p.author}</b> ${p.title}</div>
                    <div style="margin-top:10px;">
                        <input type="text" placeholder="Ajouter un commentaire..." style="background:none; border:none; border-bottom:1px solid var(--border); padding:5px 0; width:100%; color:white; outline:none;" onkeyup="if(event.key === 'Enter') App.addComment(${p.id}, this)">
                    </div>
                </div>
            </div>
        `;
    },

    // --- RENDER FEED ---
    renderFeed() {
        const feed = document.getElementById('main-feed');
        if(this.state.posts.length === 0) {
            feed.innerHTML = `
                <div style="text-align:center; padding:50px; color:var(--text-dim);">
                    <i class="fas fa-photo-video" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Le flux est vide. Soyez le premier √† publier !</p>
                    <button onclick="App.go('upload')" style="margin-top:15px; padding:12px 25px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer;">
                        <i class="fas fa-plus"></i> Cr√©er ma premi√®re publication
                    </button>
                </div>`;
            return;
        }

        feed.innerHTML = this.state.posts.map(p => this.renderPost(p)).join('');
    },

    // --- RENDER DISCOVER ---
    renderDiscover() {
        const grid = document.getElementById('discover-grid');
        const trendingPosts = [...this.state.posts]
            .sort((a, b) => b.likes - a.likes)
            .slice(0, 9);
        
        if(trendingPosts.length === 0) {
            grid.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-dim);">
                    <i class="fas fa-fire" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Aucune tendance pour le moment</p>
                    <p style="font-size:13px;">Les posts avec le plus de likes appara√Ætront ici</p>
                </div>`;
            return;
        }
        
        grid.innerHTML = trendingPosts.map(p => `
            <div style="aspect-ratio:1; background:#111; border-radius:8px; overflow:hidden; position:relative; cursor:pointer" onclick="App.viewPost(${p.id})">
                ${p.type === 'photo' ? 
                    `<img src="${p.content}" style="width:100%; height:100%; object-fit:cover;">` : 
                    `<video src="${p.content}" style="width:100%; height:100%; object-fit:cover;"></video>
                     <i class="fas fa-play" style="position:absolute; top:10px; right:10px; color:white; background:rgba(0,0,0,0.5); padding:5px; border-radius:50%; font-size:12px;"></i>`
                }
                <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.8)); padding:8px; color:white; font-size:11px;">
                    <i class="fas fa-heart" style="color:var(--accent); margin-right:5px;"></i> ${p.likes}
                </div>
            </div>
        `).join('');
    },

    // --- RENDER PROFILE ---
    renderProfile() {
        const myPosts = this.state.posts.filter(p => p.author === this.state.session.pseudo);
        document.getElementById('count-posts').innerText = myPosts.length;
        
        const grid = document.getElementById('profile-grid');
        if(myPosts.length === 0) {
            grid.innerHTML = `
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-dim);">
                    <i class="fas fa-camera" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Aucune publication pour le moment</p>
                    <button onclick="App.go('upload')" style="margin-top:15px; padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
                        Publier mon premier contenu
                    </button>
                </div>`;
            return;
        }
        
        grid.innerHTML = myPosts.map(p => `
            <div style="aspect-ratio:1; background:#111; border-radius:8px; overflow:hidden; position:relative; cursor:pointer" onclick="App.viewPost(${p.id})">
                ${p.type === 'photo' ? 
                    `<img src="${p.content}" style="width:100%; height:100%; object-fit:cover;">` : 
                    `<video src="${p.content}" style="width:100%; height:100%; object-fit:cover;"></video>
                     <i class="fas fa-play" style="position:absolute; top:8px; right:8px; color:white; background:rgba(0,0,0,0.7); padding:5px; border-radius:50%; font-size:10px;"></i>`
                }
                <div style="position:absolute; bottom:5px; left:5px; color:white; font-size:10px; background:rgba(0,0,0,0.5); padding:2px 6px; border-radius:3px;">
                    <i class="fas fa-heart"></i> ${p.likes}
                </div>
            </div>
        `).join('');
    },

    // --- VIEW POST MODAL ---
    viewPost(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${post.authorPfp}" style="width:40px; height:40px; border-radius:50%;">
                        <div>
                            <h4 style="margin:0;">${post.author}</h4>
                            <small style="color:var(--text-dim);">${this.formatTime(post.timestamp)}</small>
                        </div>
                    </div>
                    <i class="fas fa-times" style="cursor:pointer; font-size:20px;" onclick="this.closest('.modal').remove()"></i>
                </div>
                <div style="max-height:70vh; overflow-y:auto;">
                    <div class="post-media">
                        ${post.type === 'photo' ? 
                            `<img src="${post.content}" style="width:100%; max-height:60vh; object-fit:contain;">` : 
                            `<video src="${post.content}" controls style="width:100%; max-height:60vh;"></video>`
                        }
                    </div>
                    <div style="padding:20px;">
                        <div style="display:flex; gap:20px; margin-bottom:15px; font-size:20px;">
                            <i class="fa-heart ${post.likedBy.includes(this.state.session.pseudo) ? 'fas active' : 'far'}" style="cursor:pointer;" onclick="App.likePost(${post.id}); this.closest('.modal').remove();"></i>
                            <i class="far fa-comment" style="cursor:pointer;"></i>
                            <i class="far fa-share-square" style="cursor:pointer;" onclick="App.sharePost(${post.id})"></i>
                        </div>
                        <div style="margin-bottom:10px;">
                            <strong style="color:var(--accent);">${post.likes} mentions J'aime</strong>
                        </div>
                        <p><b>${post.author}</b> ${post.title}</p>
                        <p style="color:var(--text-dim); font-size:13px;">${post.views} vues</p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if(e.target === modal) modal.remove();
        });
    },

    // --- IA CHAT ENGINE ---
    initChat() {
        const chatBox = document.getElementById('chat-messages');
        chatBox.innerHTML = `
            <div class="chat-message ai-message">
                <i class="fas fa-robot" style="color:var(--ai-color); margin-right:10px; font-size:20px;"></i>
                <div>
                    <strong>Rasstube AI v4.0</strong><br>
                    <small style="color:var(--text-dim);">Syst√®me Elite Actif</small>
                    <p style="margin:10px 0 0;">Bonjour ${this.state.session.pseudo} ! Je suis votre assistant IA. Posez-moi n'importe quelle question sur Rasstube ou demandez-moi des conseils !</p>
                </div>
            </div>
        `;
    },

    askAI() {
        const input = document.getElementById('ai-input');
        const box = document.getElementById('chat-messages');
        const question = input.value.trim();
        
        if(!question) {
            this.notify("Veuillez saisir une question", "warning");
            return;
        }
        
        // Message utilisateur
        box.innerHTML += `
            <div class="chat-message user-message">
                <div style="text-align:right;">
                    <strong>${this.state.session.pseudo}</strong>
                    <p style="margin:5px 0 0;">${question}</p>
                </div>
            </div>
        `;
        
        input.value = "";
        
        // Simulation de r√©ponse IA
        setTimeout(() => {
            const responses = [
                `Pour "${question}", mon analyse Rasstube AI sugg√®re que vous explorez la section Tendances pour du contenu similaire.`,
                `Excellente question ! En tant qu'utilisateur Elite, vous avez acc√®s √† des fonctionnalit√©s avanc√©es. Je vous recommande de v√©rifier vos param√®tres de profil.`,
                `D'apr√®s mon moteur Core v4, cette fonctionnalit√© sera disponible dans la prochaine mise √† jour. Restez connect√© !`,
                `Je d√©tecte un int√©r√™t pour l'optimisation de contenu. Astuce : Utilisez des hashtags pertinents et publiez aux heures de pointe.`,
                `Question int√©ressante ! Pour maximiser votre port√©e sur Rasstube, je sugg√®re d'interagir r√©guli√®rement avec la communaut√©.`
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            box.innerHTML += `
                <div class="chat-message ai-message">
                    <i class="fas fa-robot" style="color:var(--ai-color); margin-right:10px; font-size:20px;"></i>
                    <div>
                        <strong>Rasstube AI</strong><br>
                        <small style="color:var(--text-dim);">Analyse en temps r√©el</small>
                        <p style="margin:10px 0 0;">${randomResponse}</p>
                    </div>
                </div>
            `;
            
            this.scrollChatToBottom();
        }, 1000);
    },

    scrollChatToBottom() {
        const chatBox = document.getElementById('chat-messages');
        chatBox.scrollTop = chatBox.scrollHeight;
    },

    // --- INTERACTIONS POSTS ---
    likePost(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        const index = post.likedBy.indexOf(this.state.session.pseudo);
        
        if(index === -1) {
            post.likes++;
            post.likedBy.push(this.state.session.pseudo);
            this.notify("Publication aim√©e !", "success");
        } else {
            post.likes--;
            post.likedBy.splice(index, 1);
            this.notify("Like retir√©", "info");
        }
        
        this.sync();
        this.renderFeed();
        
        // Mettre √† jour la discover si active
        if(this.state.activeSection === 'discover') {
            this.renderDiscover();
        }
    },

    postOptions(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        const options = post.author === this.state.session.pseudo ? 
            ["Supprimer", "Modifier", "Partager", "Annuler"] : 
            ["Signaler", "Partager", "Annuler"];
        
        this.notify(`Options pour le post de ${post.author}`, "info");
        
        // Simulation de menu d'options
        if(confirm(`Que souhaitez-vous faire avec le post de ${post.author}?`)) {
            if(post.author === this.state.session.pseudo) {
                if(confirm("Voulez-vous vraiment supprimer cette publication?")) {
                    this.state.posts = this.state.posts.filter(p => p.id !== id);
                    this.sync();
                    this.renderFeed();
                    this.notify("Publication supprim√©e", "success");
                }
            } else {
                this.notify("Publication signal√©e aux mod√©rateurs", "warning");
            }
        }
    },

    sharePost(id) {
        const post = this.state.posts.find(p => p.id === id);
        if(!post) return;
        
        if(navigator.share) {
            navigator.share({
                title: `Regarde √ßa sur Rasstube !`,
                text: `${post.author}: ${post.title}`,
                url: window.location.href
            });
        } else {
            prompt("Copiez ce lien pour partager:", `rasstube://post/${id}`);
            this.notify("Lien copi√© dans le presse-papier !", "success");
        }
    },

    focusComment(id) {
        const postElement = document.querySelector(`.post[data-id="${id}"]`);
        if(postElement) {
            const input = postElement.querySelector('input[type="text"]');
            if(input) input.focus();
        }
    },

    addComment(id, input) {
        if(!input.value.trim()) return;
        
        this.notify("Commentaire ajout√© !", "success");
        input.value = "";
    },

    // --- UTILS ---
    formatTime(timestamp) {
        if(!timestamp) return "√Ä l'instant";
        
        const now = new Date();
        const postDate = new Date(timestamp);
        const diff = now - postDate;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if(minutes < 1) return "√Ä l'instant";
        if(minutes < 60) return `Il y a ${minutes} min`;
        if(hours < 24) return `Il y a ${hours} h`;
        if(days < 7) return `Il y a ${days} j`;
        return postDate.toLocaleDateString('fr-FR');
    },

    notify(msg, type = "success") {
        const box = document.getElementById('notification-box');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="fas ${icons[type] || 'fa-info-circle'}" style="color:${type === 'success' ? 'var(--success)' : type === 'error' ? '#ff4444' : type === 'warning' ? 'var(--warning)' : 'var(--ai-color)'}"></i>
            <div>
                <strong style="font-size:14px;">${type.toUpperCase()}</strong>
                <p style="margin:5px 0 0; font-size:14px;">${msg}</p>
            </div>
        `;
        
        box.appendChild(toast);
        
        // Auto-remove
        setTimeout(() => {
            toast.style.animation = 'slideInRight 0.5s ease reverse';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    },

    renderAvatars() {
        const grid = document.getElementById('default-avatars');
        const seeds = ['Felix', 'Aneka', 'Rass', 'Shadow', 'Neo', 'Luna', 'Nova', 'Pulse', 'Zen', 'Vortex', 'Orion', 'Stella'];
        grid.innerHTML = seeds.map(s => {
            const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}`;
            return `
                <div class="pfp-item ${this.state.selectedPfp === url ? 'selected' : ''}" onclick="App.selectPfp('${url}')">
                    <img src="${url}" alt="${s}">
                </div>
            `;
        }).join('');
    },

    selectPfp(url) {
        this.state.selectedPfp = url;
        document.getElementById('auth-pfp-preview').src = url;
        this.renderAvatars();
    },

    handlePfpFile(e) {
        const file = e.target.files[0];
        if(!file) return;
        
        if(!file.type.includes('image')) {
            this.notify("Veuillez s√©lectionner une image", "error");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => {
            this.state.selectedPfp = event.target.result;
            document.getElementById('auth-pfp-preview').src = event.target.result;
            this.notify("Photo de profil mise √† jour", "success");
        };
        reader.readAsDataURL(file);
    },

    triggerPfpUpload() { 
        document.getElementById('real-pfp-input').click(); 
    },

    logout() {
        if(confirm("Voulez-vous vraiment vous d√©connecter de Rasstube ?")) {
            this.state.session = null;
            this.sync();
            location.reload();
        }
    }
};

// INITIALISATION
window.onload = () => App.init();

// Drag and drop pour upload
document.addEventListener('DOMContentLoaded', () => {
    const dropzone = document.getElementById('upload-dropzone');
    if(dropzone) {
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--accent)';
            dropzone.style.background = 'var(--accent-soft)';
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = 'var(--border)';
            dropzone.style.background = '';
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = 'var(--border)';
            dropzone.style.background = '';
            
            const file = e.dataTransfer.files[0];
            if(file && (file.type.includes('image') || file.type.includes('video'))) {
                const input = document.getElementById('file-upload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                
                // D√©clencher l'√©v√©nement change
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
                
                App.notify('Fichier import√© avec succ√®s !', 'success');
            } else {
                App.notify('Format de fichier non support√©', 'error');
            }
        });
    }
});
</script>
</body>
</html>