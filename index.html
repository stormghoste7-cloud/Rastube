<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RASSTUBE ULTIMATE | v4.0 Elite Ecosystem</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #FF0032;
            --accent-soft: rgba(255, 0, 50, 0.15);
            --accent-glow: rgba(255, 0, 50, 0.5);
            --bg-deep: #050505;
            --bg-card: #0F0F0F;
            --bg-elevated: #1A1A1A;
            --bg-input: #121212;
            --text-main: #FFFFFF;
            --text-dim: #909090;
            --border: rgba(255, 255, 255, 0.08);
            --ai-color: #00D1FF;
            --success: #00FF85;
            --radius-xl: 32px;
            --radius-lg: 20px;
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.6);
            --transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg-deep); color: var(--text-main); 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden; -webkit-user-select: none;
        }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseAccent { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 50, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 50, 0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- AUTHENTIFICATION ENGINE --- */
        #auth-portal {
            position: fixed; inset: 0; z-index: 9999; 
            background: radial-gradient(circle at top right, #1a0505, #000);
            display: flex; align-items: center; justify-content: center; padding: 25px;
        }

        .auth-container {
            width: 100%; max-width: 440px; background: var(--bg-card);
            border-radius: var(--radius-xl); border: 1px solid var(--border);
            padding: 45px 35px; box-shadow: var(--shadow-lg);
            animation: fadeIn 0.8s ease;
        }

        .auth-tabs {
            display: flex; background: var(--bg-input); padding: 6px;
            border-radius: 18px; margin-bottom: 35px; border: 1px solid var(--border);
        }

        .auth-tabs button {
            flex: 1; padding: 14px; border: none; background: none;
            color: var(--text-dim); font-weight: 700; cursor: pointer;
            border-radius: 14px; transition: var(--transition);
        }

        .auth-tabs button.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent-glow); }

        .input-box { margin-bottom: 22px; position: relative; }
        .input-box i { position: absolute; left: 18px; top: 18px; color: var(--text-dim); font-size: 18px; }
        .input-control {
            width: 100%; padding: 18px 18px 18px 52px; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 18px; color: white;
            font-size: 15px; transition: var(--transition);
        }
        .input-control:focus { border-color: var(--accent); outline: none; background: #161616; }

        .pfp-selector { text-align: center; margin-bottom: 25px; }
        .pfp-main-preview {
            width: 110px; height: 110px; border-radius: 50%;
            border: 3px solid var(--accent); padding: 4px; object-fit: cover;
            margin-bottom: 15px; transition: var(--transition);
        }
        .pfp-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px;
        }
        .pfp-item {
            aspect-ratio: 1; border-radius: 14px; overflow: hidden; cursor: pointer;
            border: 2px solid transparent; transition: var(--transition);
        }
        .pfp-item.selected { border-color: var(--accent); transform: scale(1.1); }
        .pfp-item img { width: 100%; height: 100%; object-fit: cover; }

        /* --- CORE APP LAYOUT --- */
        #main-app { display: none; padding-bottom: 100px; }

        .top-nav {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(25px);
            padding: 15px 20px; border-bottom: 1px solid var(--border);
        }

        .nav-wrapper {
            max-width: 1200px; margin: 0 auto;
            display: flex; justify-content: space-between; align-items: center;
        }

        .brand { font-size: 28px; font-weight: 900; color: var(--accent); letter-spacing: -1.5px; }

        .search-bar {
            background: var(--bg-elevated); border-radius: 14px;
            padding: 10px 18px; display: flex; align-items: center;
            width: 40%; border: 1px solid var(--border);
        }
        .search-bar input { background: none; border: none; color: white; margin-left: 10px; width: 100%; outline: none; }

        /* --- SECTIONS --- */
        .content-container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* Stories */
        .story-scroller {
            display: flex; gap: 18px; overflow-x: auto; padding: 10px 0 25px;
            scrollbar-width: none;
        }
        .story-card {
            flex-shrink: 0; width: 85px; text-align: center; cursor: pointer;
        }
        .story-ring {
            width: 78px; height: 78px; border-radius: 50%; padding: 3px;
            background: linear-gradient(45deg, #FF0032, #FF8A00);
            margin-bottom: 8px; transition: var(--transition);
        }
        .story-card img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--bg-deep); object-fit: cover; }
        .story-card:active .story-ring { transform: scale(0.9); }
        .story-label { font-size: 11px; font-weight: 600; color: var(--text-dim); }

        /* Post Card */
        .post {
            background: var(--bg-card); border-radius: var(--radius-lg);
            margin-bottom: 35px; border: 1px solid var(--border);
            overflow: hidden; animation: fadeIn 0.6s ease;
        }
        .post-head { padding: 18px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 14px; }
        .user-info img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .user-meta h4 { margin: 0; font-size: 15px; font-weight: 700; }
        .user-meta span { font-size: 11px; color: var(--text-dim); }

        .post-media { width: 100%; background: #000; position: relative; cursor: pointer; }
        .post-media img, .post-media video { width: 100%; display: block; max-height: 650px; object-fit: contain; }

        .post-actions { padding: 15px 20px; display: flex; gap: 25px; font-size: 24px; }
        .action-btn { cursor: pointer; transition: var(--transition); color: var(--text-main); }
        .action-btn:active { transform: scale(1.3); }
        .action-btn.active { color: var(--accent); }

        .post-details { padding: 0 20px 20px; }
        .likes-count { font-weight: 800; font-size: 14px; margin-bottom: 8px; display: block; }
        .caption { font-size: 14px; line-height: 1.5; }
        .caption b { margin-right: 8px; color: var(--accent); }

        /* --- BOTTOM NAV --- */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(30px);
            border-top: 1px solid var(--border); padding: 12px 10px 32px;
            display: flex; justify-content: space-around; z-index: 1000;
        }
        .nav-item { color: var(--text-dim); text-align: center; flex: 1; transition: var(--transition); cursor: pointer; }
        .nav-item.active { color: var(--accent); transform: translateY(-5px); }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }
        .nav-item span { font-size: 10px; font-weight: 700; text-transform: uppercase; }

        .fab-upload {
            background: var(--accent); width: 60px; height: 60px;
            border-radius: 22px; display: flex; align-items: center; justify-content: center;
            margin-top: -45px; border: 6px solid var(--bg-deep);
            color: white !important; font-size: 26px !important;
            animation: pulseAccent 2s infinite;
        }

        /* --- MODALS & OVERLAYS --- */
        .modal {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.95); display: none;
            padding: 20px; overflow-y: auto;
        }
        .modal.active { display: block; animation: fadeIn 0.4s ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

        /* --- TOAST SYSTEM --- */
        #notification-box {
            position: fixed; top: 25px; right: 25px; z-index: 10000;
        }
        .toast {
            background: var(--bg-elevated); border-left: 4px solid var(--accent);
            padding: 18px 25px; border-radius: 14px; margin-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center;
            gap: 15px; animation: slideInRight 0.5s ease;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="notification-box"></div>

<div id="auth-portal">
    <div class="auth-container">
        <div class="brand" style="text-align: center; margin-bottom: 35px; font-size: 42px;">RASSTUBE</div>
        
        <div class="auth-tabs">
            <button id="tab-login" class="active" onclick="App.toggleAuth('login')">CONNEXION</button>
            <button id="tab-signup" onclick="App.toggleAuth('signup')">INSCRIPTION</button>
        </div>

        <div id="signup-profile-setup" class="hidden">
            <div class="pfp-selector">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Rass" class="pfp-main-preview" id="auth-pfp-preview">
                <div>
                    <button onclick="App.triggerPfpUpload()" style="background:var(--accent-soft); color:var(--accent); border:none; padding:8px 15px; border-radius:10px; font-weight:700; cursor:pointer;">
                        <i class="fas fa-camera"></i> MA PHOTO
                    </button>
                </div>
                <input type="file" id="real-pfp-input" class="hidden" accept="image/*" onchange="App.handlePfpFile(event)">
                
                <div class="pfp-grid" id="default-avatars"></div>
            </div>
            
            <div class="input-box">
                <i class="fas fa-user-tag"></i>
                <input type="text" id="reg-pseudo" class="input-control" placeholder="Ton Pseudo Elite">
            </div>
        </div>

        <div class="input-box">
            <i class="fas fa-envelope"></i>
            <input type="email" id="auth-email" class="input-control" placeholder="Adresse e-mail">
        </div>
        
        <div class="input-box">
            <i class="fas fa-lock"></i>
            <input type="password" id="auth-pass" class="input-control" placeholder="Mot de passe">
        </div>

        <button onclick="App.executeAuth()" id="auth-btn" style="width: 100%; padding: 22px; background: var(--accent); color: white; border: none; border-radius: 20px; font-weight: 800; font-size: 16px; margin-top: 15px; cursor: pointer; transition: 0.3s;">
            REJOINDRE LE RÉSEAU
        </button>
        
        <p id="auth-msg" style="text-align: center; color: #ff4444; font-size: 13px; margin-top: 20px; display: none;"></p>
    </div>
</div>

<div id="main-app">
    <header class="top-nav">
        <div class="nav-wrapper">
            <div class="brand">RASSTUBE</div>
            <div class="search-bar">
                <i class="fas fa-search" style="color:var(--text-dim)"></i>
                <input type="text" placeholder="Rechercher sur le réseau..." onkeyup="App.filterContent(this.value)">
            </div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <i class="fas fa-paper-plane" style="font-size: 20px; cursor: pointer;"></i>
                <img src="" id="user-pfp-top" style="width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--accent); cursor: pointer;" onclick="App.go('profile')">
            </div>
        </div>
    </header>

    <main class="content-container">
        <section id="sec-home" class="app-section">
            <div class="story-scroller" id="story-container"></div>
            <div id="main-feed"></div>
        </section>

        <section id="sec-discover" class="app-section hidden">
            <h2 style="margin-bottom: 25px;">Tendances</h2>
            <div id="discover-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;"></div>
        </section>

        <section id="sec-chat" class="app-section hidden">
            <div style="background: var(--bg-card); border-radius: var(--radius-lg); height: calc(100vh - 280px); display: flex; flex-direction: column;">
                <div id="chat-messages" style="flex: 1; padding: 20px; overflow-y: auto;"></div>
                <div style="padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 12px;">
                    <input type="text" id="ai-input" class="input-control" placeholder="Demande n'importe quoi à l'IA..." style="margin: 0; padding-left: 20px;">
                    <button onclick="App.askAI()" style="background: var(--accent); border: none; width: 60px; border-radius: 15px; color: white;">
                        <i class="fas fa-brain"></i>
                    </button>
                </div>
            </div>
        </section>

        <section id="sec-upload" class="app-section hidden">
            <div class="auth-container" style="max-width: 100%; box-shadow: none;">
                <h3 style="margin-top: 0; margin-bottom: 25px;">Nouvelle Création</h3>
                
                <div class="input-box" style="border: 2px dashed var(--border); border-radius: 20px; padding: 40px; text-align: center; cursor: pointer;" onclick="document.getElementById('file-upload').click()">
                    <i class="fas fa-cloud-upload-alt" style="position: static; font-size: 40px; color: var(--accent); margin-bottom: 15px;"></i>
                    <p style="margin: 0; font-weight: 700;">Clique pour importer (Vidéo ou Photo)</p>
                    <input type="file" id="file-upload" class="hidden" accept="video/*,image/*" onchange="App.previewUpload(event)">
                </div>

                <div id="upload-preview" class="hidden" style="margin-bottom: 25px; border-radius: 15px; overflow: hidden;"></div>

                <div class="input-box">
                    <input type="text" id="up-title" class="input-control" placeholder="Titre de la publication" style="padding-left: 20px;">
                </div>

                <div class="input-box">
                    <select id="up-type" class="input-control" style="padding-left: 20px; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23909090%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px;">
                        <option value="video">Vidéo Standard</option>
                        <option value="photo">Photo / Image</option>
                        <option value="rshot">⚡ RShot (Format Vertical)</option>
                    </select>
                </div>

                <button onclick="App.publishPost()" style="width: 100%; padding: 20px; background: var(--accent); color: white; border: none; border-radius: 18px; font-weight: 800; cursor: pointer;">
                    LANCER LA PUBLICATION
                </button>
            </div>
        </section>

        <section id="sec-profile" class="app-section hidden">
            <div style="text-align: center; margin-bottom: 40px;">
                <img src="" id="prof-pfp" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); padding: 5px; margin-bottom: 20px;">
                <h2 id="prof-name" style="margin: 0; font-size: 28px;">Pseudo</h2>
                <p id="prof-email" style="color: var(--text-dim); margin-top: 5px;"></p>
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 25px;">
                    <div><b style="display: block; font-size: 18px;" id="count-posts">0</b><span style="font-size: 11px; color: var(--text-dim);">POSTS</span></div>
                    <div><b style="display: block; font-size: 18px;">1.4k</b><span style="font-size: 11px; color: var(--text-dim);">ABONNÉS</span></div>
                    <div><b style="display: block; font-size: 18px;">320</b><span style="font-size: 11px; color: var(--text-dim);">ELITE</span></div>
                </div>
                <button onclick="App.logout()" style="margin-top: 30px; padding: 12px 25px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; color: #ff4444; font-weight: 700; cursor: pointer;">DECONNEXION</button>
            </div>
            <div id="profile-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
        </section>
    </main>

    <nav class="bottom-bar">
        <div class="nav-item active" onclick="App.go('home')"><i class="fas fa-home"></i><span>Flux</span></div>
        <div class="nav-item" onclick="App.go('discover')"><i class="fas fa-compass"></i><span>Tendances</span></div>
        <div class="nav-item" onclick="App.go('upload')"><i class="fas fa-plus fab-upload"></i></div>
        <div class="nav-item" onclick="App.go('chat')"><i class="fas fa-robot"></i><span>IA Chat</span></div>
        <div class="nav-item" onclick="App.go('profile')"><i class="fas fa-user-shield"></i><span>Profil</span></div>
    </nav>
</div>

<script>
/**
 * RASSTUBE CORE ENGINE v4.0
 * Architecture : Gestion d'état réactive & Persistance locale
 */

const App = {
    // ÉTAT GLOBAL
    state: {
        users: JSON.parse(localStorage.getItem('rt_v4_users') || '[]'),
        posts: JSON.parse(localStorage.getItem('rt_v4_posts') || '[]'),
        session: JSON.parse(localStorage.getItem('rt_v4_session') || 'null'),
        currentTab: 'login',
        selectedPfp: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Rass',
        activeSection: 'home'
    },

    init() {
        // Correction "Ronge sa" : Vérification et nettoyage de la session
        this.verifySession();
        this.renderAvatars();
        this.sync();

        if(this.state.session) {
            this.launch();
        }
    },

    verifySession() {
        if(this.state.session) {
            const userExists = this.state.users.find(u => u.email === this.state.session.email);
            if(!userExists) {
                this.state.session = null;
                this.sync();
            }
        }
    },

    sync() {
        localStorage.setItem('rt_v4_users', JSON.stringify(this.state.users));
        localStorage.setItem('rt_v4_posts', JSON.stringify(this.state.posts));
        localStorage.setItem('rt_v4_session', JSON.stringify(this.state.session));
    },

    // --- AUTHENTIFICATION ---
    toggleAuth(tab) {
        this.state.currentTab = tab;
        document.getElementById('tab-login').classList.toggle('active', tab === 'login');
        document.getElementById('tab-signup').classList.toggle('active', tab === 'signup');
        document.getElementById('signup-profile-setup').classList.toggle('hidden', tab === 'login');
        document.getElementById('auth-btn').innerText = tab === 'login' ? "SE CONNECTER AU RÉSEAU" : "CRÉER MON COMPTE ELITE";
    },

    executeAuth() {
        const email = document.getElementById('auth-email').value.trim();
        const pass = document.getElementById('auth-pass').value;
        const msg = document.getElementById('auth-msg');

        if(!email || !pass) {
            this.notify("Veuillez remplir tous les champs", "error");
            return;
        }

        if(this.state.currentTab === 'signup') {
            const pseudo = document.getElementById('reg-pseudo').value.trim();
            if(!pseudo) { this.notify("Pseudo requis", "error"); return; }
            
            if(this.state.users.find(u => u.email === email)) {
                msg.innerText = "Cet email est déjà utilisé !";
                msg.style.display = 'block';
                return;
            }

            const newUser = {
                pseudo, email, pass, 
                pfp: this.state.selectedPfp,
                joined: new Date().toLocaleDateString()
            };

            this.state.users.push(newUser);
            this.state.session = newUser;
            this.notify("Compte créé avec succès !");
        } else {
            const user = this.state.users.find(u => u.email === email && u.pass === pass);
            if(!user) {
                msg.innerText = "Email ou mot de passe incorrect";
                msg.style.display = 'block';
                return;
            }
            this.state.session = user;
            this.notify(`Heureux de vous revoir, ${user.pseudo}`);
        }

        this.sync();
        this.launch();
    },

    launch() {
        document.getElementById('auth-portal').classList.add('hidden');
        document.getElementById('main-app').style.display = 'block';
        
        // Update UI
        document.getElementById('user-pfp-top').src = this.state.session.pfp;
        document.getElementById('prof-pfp').src = this.state.session.pfp;
        document.getElementById('prof-name').innerText = this.state.session.pseudo;
        document.getElementById('prof-email').innerText = this.state.session.email;

        this.renderFeed();
        this.renderStories();
    },

    // --- GESTION DES SECTIONS ---
    go(sec) {
        document.querySelectorAll('.app-section').forEach(s => s.classList.add('hidden'));
        document.getElementById('sec-' + sec).classList.remove('hidden');
        
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        // Mapping visuel
        const mapping = {home:0, discover:1, upload:2, chat:3, profile:4};
        document.querySelectorAll('.nav-item')[mapping[sec]].classList.add('active');

        if(sec === 'profile') this.renderProfile();
        if(sec === 'discover') this.renderDiscover();
    },

    // --- CRÉATION DE CONTENU ---
    previewUpload(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('upload-preview');
        preview.innerHTML = '';
        preview.classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (event) => {
            if(file.type.includes('video')) {
                preview.innerHTML = `<video src="${event.target.result}" style="width:100%" muted autoplay loop></video>`;
            } else {
                preview.innerHTML = `<img src="${event.target.result}" style="width:100%">`;
            }
        };
        reader.readAsDataURL(file);
    },

    publishPost() {
        const file = document.getElementById('file-upload').files[0];
        const title = document.getElementById('up-title').value;
        const type = document.getElementById('up-type').value;

        if(!file || !title) {
            this.notify("Fichier et titre obligatoires !", "error");
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const post = {
                id: Date.now(),
                author: this.state.session.pseudo,
                authorPfp: this.state.session.pfp,
                title: title,
                type: type,
                content: e.target.result,
                likes: 0,
                likedBy: []
            };

            this.state.posts.unshift(post);
            this.sync();
            this.notify("Publication en ligne !");
            this.go('home');
            this.renderFeed();
            
            // Reset fields
            document.getElementById('up-title').value = '';
            document.getElementById('upload-preview').classList.add('hidden');
        };
        reader.readAsDataURL(file);
    },

    // --- RENDERING ---
    renderFeed() {
        const feed = document.getElementById('main-feed');
        if(this.state.posts.length === 0) {
            feed.innerHTML = `
                <div style="text-align:center; padding:50px; color:var(--text-dim);">
                    <i class="fas fa-photo-video" style="font-size:40px; margin-bottom:15px;"></i>
                    <p>Le flux est vide. Soyez le premier à publier !</p>
                </div>`;
            return;
        }

        feed.innerHTML = this.state.posts.map(p => `
            <div class="post">
                <div class="post-head">
                    <div class="user-info">
                        <img src="${p.authorPfp}">
                        <div class="user-meta">
                            <h4>${p.author}</h4>
                            <span>Elite Member • Publié à l'instant</span>
                        </div>
                    </div>
                    <i class="fas fa-ellipsis-v" style="color:var(--text-dim)"></i>
                </div>
                <div class="post-media" ondblclick="App.likePost(${p.id})">
                    ${p.type === 'photo' ? `<img src="${p.content}">` : `<video src="${p.content}" controls></video>`}
                </div>
                <div class="post-actions">
                    <i class="fa-heart ${p.likedBy.includes(this.state.session.pseudo) ? 'fas active' : 'far'} action-btn" onclick="App.likePost(${p.id})"></i>
                    <i class="far fa-comment action-btn"></i>
                    <i class="far fa-paper-plane action-btn"></i>
                </div>
                <div class="post-details">
                    <span class="likes-count">${p.likes} mentions J'aime</span>
                    <div class="caption"><b>${p.author}</b> ${p.title}</div>
                </div>
            </div>
        `).join('');
    },

    renderStories() {
        const cont = document.getElementById('story-container');
        const users = ['Rayan', 'Milo', 'Sarah', 'Ines', 'Yass'];
        cont.innerHTML = `
            <div class="story-card">
                <div class="story-ring" style="background:var(--border)"><img src="${this.state.session.pfp}"></div>
                <span class="story-label">Votre story</span>
            </div>
        ` + users.map(u => `
            <div class="story-card">
                <div class="story-ring"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u}"></div>
                <span class="story-label">${u}</span>
            </div>
        `).join('');
    },

    renderProfile() {
        const myPosts = this.state.posts.filter(p => p.author === this.state.session.pseudo);
        document.getElementById('count-posts').innerText = myPosts.length;
        const grid = document.getElementById('profile-grid');
        grid.innerHTML = myPosts.map(p => `
            <div style="aspect-ratio:1; background:#111; border-radius:8px; overflow:hidden;">
                ${p.type === 'photo' ? `<img src="${p.content}" style="width:100%; height:100%; object-fit:cover;">` : `<i class="fas fa-play" style="position:absolute; color:white; padding:10px;"></i><video src="${p.content}" style="width:100%; height:100%; object-fit:cover;"></video>`}
            </div>
        `).join('');
    },

    // --- IA CHAT ENGINE ---
    askAI() {
        const input = document.getElementById('ai-input');
        const box = document.getElementById('chat-messages');
        if(!input.value) return;

        const userMsg = input.value;
        box.innerHTML += `<div style="background:var(--accent-soft); padding:15px; border-radius:15px; margin-bottom:15px; align-self:flex-end; border:1px solid var(--accent)">${userMsg}</div>`;
        
        input.value = "";
        
        setTimeout(() => {
            box.innerHTML += `<div style="background:var(--bg-elevated); padding:15px; border-radius:15px; margin-bottom:15px; border-left:4px solid var(--ai-color)">
                <i class="fas fa-robot" style="color:var(--ai-color); margin-right:10px;"></i>
                Analyse de Rasstube AI : Pour la question "${userMsg}", mon moteur Core v4 suggère que vous êtes un utilisateur Elite de la plateforme. Comment puis-je vous aider davantage ?
            </div>`;
            box.scrollTop = box.scrollHeight;
        }, 800);
    },

    // --- UTILS ---
    likePost(id) {
        const post = this.state.posts.find(p => p.id === id);
        const index = post.likedBy.indexOf(this.state.session.pseudo);
        
        if(index === -1) {
            post.likes++;
            post.likedBy.push(this.state.session.pseudo);
            this.notify("Publication aimée !");
        } else {
            post.likes--;
            post.likedBy.splice(index, 1);
        }
        
        this.sync();
        this.renderFeed();
    },

    notify(msg, type="success") {
        const box = document.getElementById('notification-box');
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}" style="color:${type==='success'?'var(--success)':'#ff4444'}"></i> ${msg}`;
        box.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    },

    renderAvatars() {
        const grid = document.getElementById('default-avatars');
        const seeds = ['Felix', 'Aneka', 'Rass', 'Shadow', 'Neo', 'Luna', 'Nova', 'Pulse'];
        grid.innerHTML = seeds.map(s => {
            const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}`;
            return `<div class="pfp-item ${this.state.selectedPfp === url ? 'selected' : ''}" onclick="App.selectPfp('${url}')"><img src="${url}"></div>`;
        }).join('');
    },

    selectPfp(url) {
        this.state.selectedPfp = url;
        document.getElementById('auth-pfp-preview').src = url;
        this.renderAvatars();
    },

    handlePfpFile(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            this.state.selectedPfp = event.target.result;
            document.getElementById('auth-pfp-preview').src = event.target.result;
        };
        reader.readAsDataURL(file);
    },

    triggerPfpUpload() { document.getElementById('real-pfp-input').click(); },

    logout() {
        if(confirm("Quitter le réseau Rasstube ?")) {
            this.state.session = null;
            this.sync();
            location.reload();
        }
    }
};

// INITIALISATION DU SYSTÈME
window.onload = () => App.init();

</script>
</body>
</html>
