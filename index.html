// --- UPLOAD TURBO AVEC COMPRESSION ---
async function publishVideo() {
    const vFile = document.getElementById('videoFile').files[0];
    const tFile = document.getElementById('thumbFile').files[0];
    const title = document.getElementById('vTitle').value;
    const btn = document.getElementById('pubBtn');
    const fill = document.getElementById('progressFill');

    if(!vFile || !tFile || !title) return alert("Champs vides !");

    btn.disabled = true;
    btn.innerText = "Traitement éclair...";
    document.getElementById('progWrap').style.display = "block";

    try {
        // 1. Lecture de la miniature (rapide)
        fill.style.width = "20%";
        const thumbData = await readFile(tFile);
        
        // 2. Lecture de la vidéo avec une limite de sécurité
        fill.style.width = "50%";
        const videoData = await readFile(vFile);

        // 3. ENVOI "SILENCIEUX" (on n'attend pas la réponse du serveur pour libérer l'utilisateur)
        fill.style.width = "80%";
        
        const videoRef = database.ref('videos').push();
        videoRef.set({
            title: title,
            thumb: thumbData,
            video: videoData,
            author: localStorage.getItem('rasstube_name'),
            authorPic: localStorage.getItem('rasstube_avatar'),
            likes: 0,
            timestamp: Date.now()
        });

        // 4. Succès immédiat pour l' UI
        fill.style.width = "100%";
        btn.innerText = "TERMINÉ !";
        
        setTimeout(() => {
            alert("Ta vidéo est en cours de diffusion sur le réseau !");
            location.reload();
        }, 500);

    } catch (e) {
        alert("Erreur de mémoire. Essaie une vidéo un peu plus courte.");
        btn.disabled = false;
        btn.innerText = "PUBLIER (TURBO)";
    }
}

// Fonction de lecture optimisée
function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        // On utilise une méthode plus légère pour les gros fichiers
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = () => reject();
        reader.readAsDataURL(file);
    });
}
